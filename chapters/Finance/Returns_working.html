
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Returns, excess returns, and common factors &#8212; Quantitative Investing</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=a3416100" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../_static/book.css?v=c2893119" />
  
  <!-- So that users can add custom icons -->
  <script src="../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'chapters/Finance/Returns_working';</script>
    <link rel="canonical" href="https://amoreira2.github.io/Fin418/chapters/Finance/Returns_working.html" />
    <link rel="icon" href="../../_static/figuremain2.jpg"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/figuremain2.jpg" class="logo__image only-light" alt="Quantitative Investing - Home"/>
    <img src="../../_static/figuremain2.jpg" class="logo__image only-dark pst-js-only" alt="Quantitative Investing - Home"/>
  
  
</a></div>
        <div class="sidebar-primary-item">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <ul class="nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../01/what-is-quant-investing.html">1. What is Quantitative Investing?</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../01/statistical-techniques.html">1.1. Statistical Techniques</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01/computational-tools.html">1.2. Computational tools</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../02/getting_started.html">2. Getting Started</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../02/local_install.html">2.3. Local installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02/cloud_setup.html">2.4. Cloud Setup</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../essentials/intro.html">3. First steps with Python</a></li>










<li class="toctree-l1 has-children"><a class="reference internal" href="Returns.html">14. Asset Returns</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="UsingAPI.html">14.3. Data APIs</a></li>
<li class="toctree-l2"><a class="reference internal" href="TheChoiceofFrequency.html">14.4. The Choice of Frequency and Annualization of Returns</a></li>
<li class="toctree-l2"><a class="reference internal" href="../scientific/randomness1.html">14.5. Modeling randomness</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="FactorModels.html">15. Factor Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="FactorModelEstimation.html">16. Factor Model Estimation</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="PortfolioMath.html">17. Portfolios</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="LeverageandShorting.html">17.8. Leverage and Shorting</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="Performance_evaluation.html">18. Performance Evaluation</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="crosssectionalequitystrategies.html">19. Cross-Sectional Equity Strategies</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="Momentum.html">19.3. Momentum factor</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="MultiFactorModels.html">20. Multi Factor Models</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="Factors.html">20.9. An overview of factors</a></li>
<li class="toctree-l2"><a class="reference internal" href="InterpretingFactorModels.html">20.10. Interpreting Factor Models</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="MachineLearning.html">21. Machine Learning in Finance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../additional/additional.html">22. Additional Statistics Material</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Assignments/Assignments.html">23. Assignments</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/amoreira2/Fin418/blob/main/chapters/Finance/Returns_working.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Colab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Colab logo" src="../../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/amoreira2/Fin418" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/amoreira2/Fin418/issues/new?title=Issue%20on%20page%20%2Fchapters/Finance/Returns_working.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/chapters/Finance/Returns_working.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button>


<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Returns, excess returns, and common factors</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#what-is-a-return">What is a return?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#decomposing-returns">Decomposing Returns</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#striping-the-risk-free-rate">Striping the risk-free rate</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#risk-premiums">Risk Premiums</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#stripping-the-common-factor">Stripping the common factor</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#towards-a-factor-model">Towards a factor Model</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># load libraries used in this notebook</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">wrds</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># functions that we will use in this notebook that you don;t need to worry about for now</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_daily_wrds_single_ticker</span><span class="p">(</span><span class="n">ticker</span><span class="p">,</span><span class="n">conn</span><span class="p">,</span><span class="n">dividends</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">tickers</span> <span class="o">=</span> <span class="p">[</span><span class="n">ticker</span><span class="p">]</span>
    <span class="c1"># Retrieve PERMNOs for the specified tickers</span>
    <span class="n">permnos</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="n">library</span><span class="o">=</span><span class="s1">&#39;crsp&#39;</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="s1">&#39;stocknames&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;ticker&#39;</span><span class="p">,</span> <span class="s1">&#39;namedt&#39;</span><span class="p">,</span> <span class="s1">&#39;nameenddt&#39;</span><span class="p">])</span>
    <span class="n">permnos</span><span class="p">[</span><span class="s1">&#39;nameenddt&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">permnos</span><span class="p">[</span><span class="s1">&#39;nameenddt&#39;</span><span class="p">])</span>
    <span class="n">permnos</span> <span class="o">=</span> <span class="n">permnos</span><span class="p">[(</span><span class="n">permnos</span><span class="p">[</span><span class="s1">&#39;ticker&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">tickers</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">permnos</span><span class="p">[</span><span class="s1">&#39;nameenddt&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">permnos</span><span class="p">[</span><span class="s1">&#39;nameenddt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())]</span>
    <span class="c1"># Extract unique PERMNOs</span>
    <span class="n">permno_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">permnos</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">permno_list</span><span class="p">)</span>

    <span class="c1"># Query daily stock file for the specified PERMNOs</span>
    <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        SELECT permno, date, ret, retx, prc       </span>
<span class="s2">        FROM crsp.dsf</span>
<span class="s2">        WHERE permno IN (</span><span class="si">{</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="w"> </span><span class="n">permno_list</span><span class="p">))</span><span class="si">}</span><span class="s2">)</span>
<span class="s2">        ORDER BY date</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="n">daily_returns</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">raw_sql</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">date_cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>
    <span class="n">daily_returns</span> <span class="o">=</span> <span class="n">daily_returns</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">permnos</span><span class="p">[[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;ticker&#39;</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
    <span class="c1"># Pivot data to have dates as index and tickers as columns</span>
    <span class="c1"># daily_returns = daily_returns.pivot(index=&#39;date&#39;, columns=&#39;ticker&#39;, values=&#39;ret&#39;)</span>
    <span class="c1"># daily_returns=daily_returns[&#39;2000&#39;:]</span>
    <span class="k">if</span> <span class="n">dividends</span><span class="p">:</span>
        <span class="n">daily_returns</span><span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">daily_returns</span><span class="o">.</span><span class="n">ret</span><span class="o">-</span><span class="n">daily_returns</span><span class="o">.</span><span class="n">retx</span><span class="p">)</span><span class="o">*</span><span class="n">daily_returns</span><span class="o">.</span><span class="n">prc</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">daily_returns</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">daily_returns</span><span class="o">.</span><span class="n">prc</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
        <span class="n">daily_returns</span><span class="o">=</span><span class="n">daily_returns</span><span class="p">[[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;P&#39;</span><span class="p">,</span><span class="s1">&#39;D&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">daily_returns</span><span class="o">=</span><span class="n">daily_returns</span><span class="p">[[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;ret&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>    


    <span class="k">return</span> <span class="n">daily_returns</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_daily_wrds_multiple_ticker</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span><span class="n">conn</span><span class="p">):</span>
  
    <span class="c1"># Retrieve PERMNOs for the specified tickers</span>
    <span class="n">permnos</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="n">library</span><span class="o">=</span><span class="s1">&#39;crsp&#39;</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="s1">&#39;stocknames&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;ticker&#39;</span><span class="p">,</span> <span class="s1">&#39;namedt&#39;</span><span class="p">,</span> <span class="s1">&#39;nameenddt&#39;</span><span class="p">])</span>
    <span class="n">permnos</span><span class="p">[</span><span class="s1">&#39;nameenddt&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">permnos</span><span class="p">[</span><span class="s1">&#39;nameenddt&#39;</span><span class="p">])</span>
    <span class="n">permnos</span> <span class="o">=</span> <span class="n">permnos</span><span class="p">[(</span><span class="n">permnos</span><span class="p">[</span><span class="s1">&#39;ticker&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">tickers</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">permnos</span><span class="p">[</span><span class="s1">&#39;nameenddt&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">permnos</span><span class="p">[</span><span class="s1">&#39;nameenddt&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())]</span>
    <span class="c1"># Extract unique PERMNOs</span>
    <span class="n">permno_list</span> <span class="o">=</span> <span class="n">permnos</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">permno_list</span><span class="p">)</span>

    <span class="c1"># Query daily stock file for the specified PERMNOs</span>
    <span class="n">query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        SELECT permno, date, ret, retx, prc       </span>
<span class="s2">        FROM crsp.dsf</span>
<span class="s2">        WHERE permno IN (</span><span class="si">{</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="w"> </span><span class="n">permno_list</span><span class="p">))</span><span class="si">}</span><span class="s2">)</span>
<span class="s2">        ORDER BY date</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="n">daily_returns</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">raw_sql</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">date_cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>
    <span class="n">daily_returns</span> <span class="o">=</span> <span class="n">daily_returns</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">permnos</span><span class="p">[[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="s1">&#39;ticker&#39;</span><span class="p">]],</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
    <span class="c1"># Pivot data to have dates as index and tickers as columns</span>
    <span class="n">daily_returns</span> <span class="o">=</span> <span class="n">daily_returns</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;ticker&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;ret&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>    
    <span class="n">daily_returns</span><span class="o">=</span><span class="n">daily_returns</span><span class="p">[</span><span class="n">tickers</span><span class="p">]</span>



    <span class="k">return</span> <span class="n">daily_returns</span>


<span class="c1"># tickers = [&#39;UNH&#39;]</span>
<span class="c1"># # Retrieve PERMNOs for the specified tickers</span>
<span class="c1"># permnos = conn.get_table(library=&#39;crsp&#39;, table=&#39;stocknames&#39;, columns=[&#39;permno&#39;, &#39;ticker&#39;, &#39;namedt&#39;, &#39;nameenddt&#39;])</span>
<span class="c1"># permnos[&#39;nameenddt&#39;]=pd.to_datetime(permnos[&#39;nameenddt&#39;])</span>
<span class="c1"># permnos = permnos[(permnos[&#39;ticker&#39;].isin(tickers)) &amp; (permnos[&#39;nameenddt&#39;]==permnos[&#39;nameenddt&#39;].max())]</span>

<span class="c1"># # Extract unique PERMNOs</span>
<span class="c1"># permno_list = permnos[&#39;permno&#39;].unique().tolist()</span>

<span class="c1"># # Query daily stock file for the specified PERMNOs</span>
<span class="c1"># query = f&quot;&quot;&quot;</span>
<span class="c1">#     SELECT permno, date, ret,       </span>
<span class="c1">#     FROM crsp.dsf</span>
<span class="c1">#     WHERE permno IN ({&#39;,&#39;.join(map(str, permno_list))})</span>
<span class="c1">#     ORDER BY date</span>
<span class="c1"># &quot;&quot;&quot;</span>
<span class="c1"># daily_returns = conn.raw_sql(query, date_cols=[&#39;date&#39;])</span>
<span class="c1"># daily_returns = daily_returns.merge(permnos[[&#39;permno&#39;, &#39;ticker&#39;]], on=&#39;permno&#39;, how=&#39;left&#39;)</span>
<span class="c1"># # Pivot data to have dates as index and tickers as columns</span>
<span class="c1"># daily_returns = daily_returns.pivot(index=&#39;date&#39;, columns=&#39;ticker&#39;, values=&#39;ret&#39;)</span>
<span class="c1"># daily_returns=daily_returns[&#39;2000&#39;:]</span>
</pre></div>
</div>
</div>
</div>
<section class="tex2jax_ignore mathjax_ignore" id="returns-excess-returns-and-common-factors">
<h1>Returns, excess returns, and common factors<a class="headerlink" href="#returns-excess-returns-and-common-factors" title="Link to this heading">#</a></h1>
<ul class="simple">
<li><p>Define what are returns, which is the key variable of analysis in finance (and this class).</p></li>
<li><p>Discuss how to think them of random variables</p></li>
<li><p>Discuss the key statistical “moments” that we will use to capture their behavior (i.e. how risky they are)</p></li>
<li><p>Discuss the normal distribution specifically</p></li>
<li><p>Define the concept of Excess returns</p></li>
</ul>
<section id="what-is-a-return">
<h2>What is a return?<a class="headerlink" href="#what-is-a-return" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Lets say you paid <span class="math notranslate nohighlight">\(𝑃_𝑡\)</span> in date <span class="math notranslate nohighlight">\(t\)</span> for an asset</p></li>
<li><p>In date <span class="math notranslate nohighlight">\(t+1\)</span> the price is <span class="math notranslate nohighlight">\(𝑃_{𝑡+1}\)</span>  and you earn some dividend as well <span class="math notranslate nohighlight">\(𝐷_{𝑡+1}\)</span></p></li>
<li><p>Then we say that your return is</p></li>
</ul>
<div class="math notranslate nohighlight">
\[𝑅_{𝑡+1}=\frac{𝑃_{𝑡+1}+𝐷_{𝑡+1}−𝑃_𝑡}{𝑃_𝑡}\]</div>
<ul class="simple">
<li><p>It is the gain you made (everything that you go in date t+1), divided by how much you put in ( the price of the asset)</p></li>
<li><p>This definition works for ANY asset that has a positive price</p></li>
<li><p>This is the case for stocks, bonds, commodities, crypto, most real assets</p></li>
<li><p>The return simply normalizes the “dollar gain” by the cost of the asset.</p></li>
<li><p>In practice there are many types of distributions that are economically like a dividend but have different names: cash dividends, stock dividends, capital gain distributions, rights offerings, acquisition  related distributions, splits</p></li>
</ul>
<p>Lets start by loading Price and Dividend data on a single stock</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">conn</span> <span class="o">=</span> <span class="n">wrds</span><span class="o">.</span><span class="n">Connection</span><span class="p">()</span>
<span class="n">df_UNH</span><span class="o">=</span><span class="n">get_daily_wrds_single_ticker</span><span class="p">(</span><span class="s1">&#39;UNH&#39;</span><span class="p">,</span><span class="n">conn</span><span class="p">)</span>
<span class="n">df_UNH</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WRDS recommends setting up a .pgpass file.
Created .pgpass file successfully.
You can create this file yourself at any time with the create_pgpass_file() function.
Loading library list...
Done
[92655]
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>P</th>
      <th>D</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1984-10-18</th>
      <td>4.87500</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1984-10-19</th>
      <td>4.68750</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1984-10-22</th>
      <td>4.68750</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1984-10-23</th>
      <td>4.56250</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1984-10-24</th>
      <td>4.68750</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2023-12-22</th>
      <td>520.31000</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2023-12-26</th>
      <td>520.03003</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2023-12-27</th>
      <td>522.78998</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2023-12-28</th>
      <td>524.90002</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2023-12-29</th>
      <td>526.46997</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
<p>9879 rows × 2 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#How do we construct returns?</span>


<span class="n">df_UNH</span><span class="p">[</span><span class="s1">&#39;ret&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">df_UNH</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">df_UNH</span><span class="p">[</span><span class="s1">&#39;D&#39;</span><span class="p">])</span><span class="o">/</span><span class="n">df_UNH</span><span class="p">[</span><span class="s1">&#39;P&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>

<span class="n">df_UNH</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>P</th>
      <th>D</th>
      <th>ret</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1984-10-18</th>
      <td>4.87500</td>
      <td>0.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1984-10-19</th>
      <td>4.68750</td>
      <td>0.0</td>
      <td>-0.038462</td>
    </tr>
    <tr>
      <th>1984-10-22</th>
      <td>4.68750</td>
      <td>0.0</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>1984-10-23</th>
      <td>4.56250</td>
      <td>0.0</td>
      <td>-0.026667</td>
    </tr>
    <tr>
      <th>1984-10-24</th>
      <td>4.68750</td>
      <td>0.0</td>
      <td>0.027397</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2023-12-22</th>
      <td>520.31000</td>
      <td>0.0</td>
      <td>0.000827</td>
    </tr>
    <tr>
      <th>2023-12-26</th>
      <td>520.03003</td>
      <td>0.0</td>
      <td>-0.000538</td>
    </tr>
    <tr>
      <th>2023-12-27</th>
      <td>522.78998</td>
      <td>0.0</td>
      <td>0.005307</td>
    </tr>
    <tr>
      <th>2023-12-28</th>
      <td>524.90002</td>
      <td>0.0</td>
      <td>0.004036</td>
    </tr>
    <tr>
      <th>2023-12-29</th>
      <td>526.46997</td>
      <td>0.0</td>
      <td>0.002991</td>
    </tr>
  </tbody>
</table>
<p>9879 rows × 3 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_UNH</span><span class="p">[</span><span class="s1">&#39;ret&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.0009104234710832472
</pre></div>
</div>
</div>
</div>
<p>If I have invested 100 dollars in a random month in the sample, on average I would have 100.09 in month t+1 in the sample</p>
<p>A return of</p>
<div class="math notranslate nohighlight">
\[\frac{100.09-100}{100}=0.09\%\]</div>
<p>Suppose that at the start of the sample we invested 1 dollar in this stock and got all the dividends and used to buy more of the stock,</p>
<ul class="simple">
<li><p>how many dollars we would have at the end of the sample?</p></li>
<li><p>What is the cumulative return on our investment?</p></li>
<li><p>What is the annualized return?</p></li>
<li><p>What is the dividend yield?</p></li>
</ul>
<div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">((</span><span class="n">df_UNH</span><span class="p">[</span><span class="s1">&#39;ret&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">())</span>

<span class="nb">print</span><span class="p">((</span><span class="n">df_UNH</span><span class="p">[</span><span class="s1">&#39;ret&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>


<span class="nb">print</span><span class="p">((</span><span class="n">df_UNH</span><span class="p">[</span><span class="s1">&#39;ret&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span><span class="o">**</span><span class="p">(</span><span class="mi">252</span><span class="o">/</span><span class="n">df_UNH</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>


<span class="p">(</span><span class="n">df_UNH</span><span class="o">.</span><span class="n">D</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span><span class="mi">252</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="n">df_UNH</span><span class="o">.</span><span class="n">P</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>134.59749454136372
133.59749454136372
0.13320600988316555
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Axes: xlabel=&#39;date&#39;&gt;
</pre></div>
</div>
<img alt="../../_images/a53f5b94d2460df8e95484e15729535f941dd72e02659087367f8bf6b221e4a3.png" src="../../_images/a53f5b94d2460df8e95484e15729535f941dd72e02659087367f8bf6b221e4a3.png" />
</div>
</details>
</div>
<p>Suppose we are now at the end of the sample</p>
<ul class="simple">
<li><p>You have 1000 dollars invested in this stock in the end of the sample, the next day there’s a 16% chance your portfolio’s value will fall below a certain amount. How would you estimate that value?</p></li>
<li><p>Now suppose you want to know this value in one year? What is your estimate of this value?</p></li>
<li><p>What is the expected value of your holdings in one year? How should you think about estimating this?</p></li>
</ul>
<p>What plot can you do to have a sense of the distribution of 1 day returns? And 1 year returns?</p>
<p>What plot can you to give you a sense of these returns varying over time?</p>
<p>What drives these returns? Why do they vary over time?</p>
</section>
<section id="decomposing-returns">
<h2>Decomposing Returns<a class="headerlink" href="#decomposing-returns" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Returns of an individual stock can be driven by many things</p>
<ul>
<li><p>Time-value of money. There are periods where you can get very high returns even in perfectly safe assets</p></li>
<li><p>Common factors, examples: all stocks went up because of a stronger economy, all stocks went down because of a financial crisis</p></li>
<li><p>Individual factors impacting the stock: A new drug/a new technology that the firm sells. Anything specific to the firm</p></li>
</ul>
</li>
</ul>
<p>When investing is essential to understand where you are performance comes from</p>
<p>We will build towards a framework of investing that thinks differently about investing on systematic risk and idiosyncratic risk</p>
<p>The first step will be to build this decomposition, which will start now and culminate in our factor models lecture</p>
<section id="striping-the-risk-free-rate">
<h3>Striping the risk-free rate<a class="headerlink" href="#striping-the-risk-free-rate" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>In this class we will do a lot of decomposing, but lets start by stripping down the “time-value of money” piece</p></li>
<li><p>We first define an “<b>excess return</b>”： the return minus the risk-free rate</p></li>
</ul>
<div class="math notranslate nohighlight">
\[excess~return^{stock~i}=return^{stock~i}-risk~free~rate\]</div>
<ul class="simple">
<li><p>We typically use the returns of a 3-month treasury bill to measure the risk-free rate</p></li>
<li><p>We will denote <span class="math notranslate nohighlight">\(rf\)</span> for the risk-free rate</p></li>
<li><p>We often add superscript e to denote an excess return.</p></li>
<li><p>so if <span class="math notranslate nohighlight">\(r^i\)</span> stands for the return of stock <span class="math notranslate nohighlight">\(i\)</span>, then <span class="math notranslate nohighlight">\(r^{e,i}\)</span> is it’s excess return</p></li>
<li><p>Conceptually you want to use the risk-free asset for the relevant holding period you are evaluating the asset returns, but for this class you can think of the “Fed Funds Rate” or the “3-month treasury-bill rate”</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pandas_datareader.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">DataReader</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>

<span class="c1"># Define the date range</span>
<span class="n">start_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">1960</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Start date (adjust as needed)</span>
<span class="n">end_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>          <span class="c1"># End date</span>

<span class="c1"># Fetch the data from FRED for 3-month Treasury Bill rates (symbol: DGS3MO)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">df_rf</span> <span class="o">=</span> <span class="n">DataReader</span><span class="p">(</span><span class="s2">&quot;DGS3MO&quot;</span><span class="p">,</span> <span class="s2">&quot;fred&quot;</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">)</span>
    <span class="n">df_rf</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df_rf</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="s2">&quot;rf&quot;</span><span class="p">]</span>
    <span class="n">df_rf</span><span class="o">.</span><span class="n">rf</span><span class="o">=</span><span class="n">df_rf</span><span class="o">.</span><span class="n">rf</span><span class="o">/</span><span class="mi">100</span>
    <span class="n">df_rf</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;An error occurred: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">df_rf</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Axes: xlabel=&#39;Date&#39;&gt;
</pre></div>
</div>
<img alt="../../_images/e14ec7c0f76ec4849e44e82a8d96e3fdb03967854d60502f45d95ae7405b12e2.png" src="../../_images/e14ec7c0f76ec4849e44e82a8d96e3fdb03967854d60502f45d95ae7405b12e2.png" />
</div>
</div>
<p>How do we interpret this rate?</p>
<p>Say if I invested in the tbill in 2005 how much money I would have in the end of 3 months? And in the end of the year?</p>
<p>Lets get another stock to play with and merge it together with our risk-free return</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">=</span><span class="n">get_daily_wrds_single_ticker</span><span class="p">(</span><span class="s1">&#39;NVDA&#39;</span><span class="p">,</span><span class="n">conn</span><span class="p">,</span><span class="n">dividends</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_rf</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
<span class="n">df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[86580]
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>ret</th>
      <th>rf</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1999-01-25</th>
      <td>0.104762</td>
      <td>0.0444</td>
    </tr>
    <tr>
      <th>1999-01-26</th>
      <td>-0.077586</td>
      <td>0.0446</td>
    </tr>
    <tr>
      <th>1999-01-27</th>
      <td>-0.003115</td>
      <td>0.0447</td>
    </tr>
    <tr>
      <th>1999-01-28</th>
      <td>-0.003125</td>
      <td>0.0449</td>
    </tr>
    <tr>
      <th>1999-01-29</th>
      <td>-0.047022</td>
      <td>0.0448</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2023-12-22</th>
      <td>-0.003266</td>
      <td>0.0544</td>
    </tr>
    <tr>
      <th>2023-12-26</th>
      <td>0.009195</td>
      <td>0.0545</td>
    </tr>
    <tr>
      <th>2023-12-27</th>
      <td>0.002800</td>
      <td>0.0544</td>
    </tr>
    <tr>
      <th>2023-12-28</th>
      <td>0.002125</td>
      <td>0.0545</td>
    </tr>
    <tr>
      <th>2023-12-29</th>
      <td>0.000000</td>
      <td>0.0540</td>
    </tr>
  </tbody>
</table>
<p>6275 rows × 2 columns</p>
</div></div></div>
</div>
<p>Lets construct another column called ‘ret_e’ for excess returns</p>
<p>What is the trading interpretation of such series?</p>
<p>Is it the “return” to which strategy exactly?</p>
<ul class="simple">
<li><p>How the historical distributions of ret and rete compare?</p></li>
<li><p>Are their averages similar?</p></li>
<li><p>are their historical standard deviations  similar?</p></li>
<li><p>Do they have similar interpretation?</p></li>
<li><p>Is the standard-deviation of risk-free rate useful to tell you the distribution of you returns in the end of 3 months?</p></li>
</ul>
</section>
</section>
<section id="risk-premiums">
<h2>Risk Premiums<a class="headerlink" href="#risk-premiums" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>We call the risk-premium what we earn in excess of what a risk-free investment pays</p></li>
<li><p>So the risk premium of an asset is the expected value of the excess return</p></li>
</ul>
<div class="math notranslate nohighlight">
\[risk~premium~of~stock~i=E[r^{e,i}]\]</div>
<p>So the expected return of a stock is</p>
<div class="math notranslate nohighlight">
\[E[r^i]=rf+E[r^{e,i}]\]</div>
<p>The realized return is obviously volatile, hence the risk</p>
<div class="math notranslate nohighlight">
\[u_i=r^{e,i}-E[r^{e,i}]\]</div>
<p>will be negative 50% of the time and sometimes quite negative!</p>
<p>Big picture level the goal of quant investing is to harvest these risk-premia while managing the risk</p>
<ul class="simple">
<li><p>We know the risk-free rate (it is the yield on a short-term government bond)</p></li>
<li><p>How do we figure out the risk-premium of an asset?</p></li>
</ul>
<section id="stripping-the-common-factor">
<h3>Stripping the common factor<a class="headerlink" href="#stripping-the-common-factor" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>We will build a simple model to help us both think about this risk-premium and also the risk that we need to manage</p></li>
<li><p>It will be useful to decompose the excess returns further to better understand it’s risk and it’s premium</p></li>
<li><p>We know that the overall market portfolio moves around, so it is natural to strip that market-wide movement from the stock returns</p></li>
<li><p>Suppose f is this common factor, one possibility is to write</p></li>
</ul>
<div class="math notranslate nohighlight">
\[r^{i}=r^i-rf+rf\]</div>
<div class="math notranslate nohighlight">
\[r^{i}=r^i-rf+rf-f+f\]</div>
<p>Reorganizing we have that the return can be written as</p>
<div class="math notranslate nohighlight">
\[r^{i}=rf+f+r^{e,i}-f\]</div>
<div class="math notranslate nohighlight">
\[r^i=risk~free~rate(rf)+factor(f)+firm~specific~component (r^{e,i}-f)\]</div>
<ul class="simple">
<li><p>What is this common factor?</p></li>
<li><p>Will this work? When will it work?</p></li>
</ul>
<ul class="simple">
<li><p>I will use the returns on the SPY etf as a market proxy, i.e</p></li>
</ul>
<div class="math notranslate nohighlight">
\[f=return^{SPY}\]</div>
<ul class="simple">
<li><p>This funds holds a market-capitalization weighted portfolio of the largest 500 US stocks (roughly)–this consists of about 85% of the total universe of investable US equities</p></li>
<li><p>The press often cites the DOW JONES as another proxy for the overall movement in stocks–but it is a terrible proxy, since is a equal weighted portfolio of 30 arbitrary chosen stocks. Please never ever use that</p></li>
<li><p>If you really want to use a portfolio that tracks the entirety of the US stock market universe you can use VTI which is a ETF that holds market-capitalization weighted portfolio of all publicly traded US stocks. About 60 Trillion investment universe</p></li>
<li><p>For reasons that will be clear later–but don;t matter for now, I will also strip the risk-free rate from our common factor</p></li>
</ul>
<div class="math notranslate nohighlight">
\[f=return^{SPY}-rf\]</div>
<ul class="simple">
<li><p>Is there only one factor?</p></li>
<li><p>What other factors beyond the market comes to mind?</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#conn = wrds.Connection()</span>
<span class="n">df</span><span class="o">=</span><span class="n">get_daily_wrds_multiple_ticker</span><span class="p">([</span><span class="s1">&#39;SPY&#39;</span><span class="p">,</span><span class="s1">&#39;WMT&#39;</span><span class="p">,</span><span class="s1">&#39;JPM&#39;</span><span class="p">],</span><span class="n">conn</span><span class="p">)</span>
<span class="c1">#Why did I divide by 252?</span>
<span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_rf</span><span class="o">/</span><span class="mi">252</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
<span class="n">df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[47896, 55976, 84398]
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>SPY</th>
      <th>WMT</th>
      <th>JPM</th>
      <th>rf</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1993-02-01</th>
      <td>0.007112</td>
      <td>0.011516</td>
      <td>0.009231</td>
      <td>0.000119</td>
    </tr>
    <tr>
      <th>1993-02-02</th>
      <td>0.002119</td>
      <td>0.005693</td>
      <td>0.003049</td>
      <td>0.000120</td>
    </tr>
    <tr>
      <th>1993-02-03</th>
      <td>0.010571</td>
      <td>0.009434</td>
      <td>0.012158</td>
      <td>0.000119</td>
    </tr>
    <tr>
      <th>1993-02-04</th>
      <td>0.004184</td>
      <td>-0.003738</td>
      <td>0.012012</td>
      <td>0.000117</td>
    </tr>
    <tr>
      <th>1993-02-05</th>
      <td>-0.000694</td>
      <td>-0.011257</td>
      <td>0.017804</td>
      <td>0.000117</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2023-12-22</th>
      <td>0.002010</td>
      <td>0.011951</td>
      <td>-0.000597</td>
      <td>0.000216</td>
    </tr>
    <tr>
      <th>2023-12-26</th>
      <td>0.004223</td>
      <td>-0.001532</td>
      <td>0.005914</td>
      <td>0.000216</td>
    </tr>
    <tr>
      <th>2023-12-27</th>
      <td>0.001808</td>
      <td>0.009398</td>
      <td>0.005998</td>
      <td>0.000216</td>
    </tr>
    <tr>
      <th>2023-12-28</th>
      <td>0.000378</td>
      <td>-0.001964</td>
      <td>0.005313</td>
      <td>0.000216</td>
    </tr>
    <tr>
      <th>2023-12-29</th>
      <td>-0.002895</td>
      <td>0.000508</td>
      <td>-0.001174</td>
      <td>0.000214</td>
    </tr>
  </tbody>
</table>
<p>7785 rows × 4 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># will create excess retursn</span>

<span class="n">df_re</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s1">&#39;rf&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;rf&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">df_re</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>SPY</th>
      <th>WMT</th>
      <th>JPM</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1993-02-01</th>
      <td>0.006993</td>
      <td>0.011397</td>
      <td>0.009112</td>
    </tr>
    <tr>
      <th>1993-02-02</th>
      <td>0.001999</td>
      <td>0.005573</td>
      <td>0.002929</td>
    </tr>
    <tr>
      <th>1993-02-03</th>
      <td>0.010452</td>
      <td>0.009315</td>
      <td>0.012039</td>
    </tr>
    <tr>
      <th>1993-02-04</th>
      <td>0.004067</td>
      <td>-0.003855</td>
      <td>0.011895</td>
    </tr>
    <tr>
      <th>1993-02-05</th>
      <td>-0.000811</td>
      <td>-0.011374</td>
      <td>0.017687</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2023-12-22</th>
      <td>0.001794</td>
      <td>0.011735</td>
      <td>-0.000813</td>
    </tr>
    <tr>
      <th>2023-12-26</th>
      <td>0.004007</td>
      <td>-0.001748</td>
      <td>0.005698</td>
    </tr>
    <tr>
      <th>2023-12-27</th>
      <td>0.001592</td>
      <td>0.009182</td>
      <td>0.005782</td>
    </tr>
    <tr>
      <th>2023-12-28</th>
      <td>0.000162</td>
      <td>-0.002180</td>
      <td>0.005097</td>
    </tr>
    <tr>
      <th>2023-12-29</th>
      <td>-0.003109</td>
      <td>0.000294</td>
      <td>-0.001388</td>
    </tr>
  </tbody>
</table>
<p>7785 rows × 3 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">statsmodels.api</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sm</span>


<span class="c1"># Function to add regression line and beta coefficient</span>

<span class="n">df_re</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;SPY&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;WMT&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;SPY vs WMT&#39;</span><span class="p">)</span>

<span class="c1"># Scatter plot for SPY vs CSCO</span>
<span class="n">df_re</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;SPY&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;JPM&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;SPY vs JPM&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/e921cc86545c90e5126e9e6615e9cfc661a4a7223c1ae6b32c8890ee9ad399f1.png" src="../../_images/e921cc86545c90e5126e9e6615e9cfc661a4a7223c1ae6b32c8890ee9ad399f1.png" />
</div>
</div>
<p>Indeed we see quite a bit of co-movement!</p>
<p>Days that SPY return is up, Both stocks tend to be up as well</p>
<p>Another way of see this is looking at the correlation between the stocks and the factor</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_re</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>SPY</th>
      <th>WMT</th>
      <th>JPM</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>SPY</th>
      <td>1.000000</td>
      <td>0.496421</td>
      <td>0.711185</td>
    </tr>
    <tr>
      <th>WMT</th>
      <td>0.496421</td>
      <td>1.000000</td>
      <td>0.328472</td>
    </tr>
    <tr>
      <th>JPM</th>
      <td>0.711185</td>
      <td>0.328472</td>
      <td>1.000000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Lets try to clean the stock from exposure to the common factor by subtracting it out</p>
<p>‘m_spy’ denote the returns minus the return on the factor</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_re</span><span class="p">[[</span><span class="s1">&#39;WMT_m_spy&#39;</span><span class="p">,</span><span class="s1">&#39;JPM_m_spy&#39;</span><span class="p">]]</span><span class="o">=</span><span class="n">df_re</span><span class="p">[[</span><span class="s1">&#39;WMT&#39;</span><span class="p">,</span><span class="s1">&#39;JPM&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>ticker</th>
      <th>SPY</th>
      <th>WMT</th>
      <th>JPM</th>
      <th>WMT_m_spy</th>
      <th>JPM_m_spy</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1993-02-01</th>
      <td>0.007112</td>
      <td>0.011516</td>
      <td>0.009231</td>
      <td>0.004404</td>
      <td>0.002119</td>
    </tr>
    <tr>
      <th>1993-02-02</th>
      <td>0.002119</td>
      <td>0.005693</td>
      <td>0.003049</td>
      <td>0.003574</td>
      <td>0.000930</td>
    </tr>
    <tr>
      <th>1993-02-03</th>
      <td>0.010571</td>
      <td>0.009434</td>
      <td>0.012158</td>
      <td>-0.001137</td>
      <td>0.001587</td>
    </tr>
    <tr>
      <th>1993-02-04</th>
      <td>0.004184</td>
      <td>-0.003738</td>
      <td>0.012012</td>
      <td>-0.007922</td>
      <td>0.007828</td>
    </tr>
    <tr>
      <th>1993-02-05</th>
      <td>-0.000694</td>
      <td>-0.011257</td>
      <td>0.017804</td>
      <td>-0.010563</td>
      <td>0.018498</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2023-12-22</th>
      <td>0.002010</td>
      <td>0.011951</td>
      <td>-0.000597</td>
      <td>0.009941</td>
      <td>-0.002607</td>
    </tr>
    <tr>
      <th>2023-12-26</th>
      <td>0.004223</td>
      <td>-0.001532</td>
      <td>0.005914</td>
      <td>-0.005755</td>
      <td>0.001691</td>
    </tr>
    <tr>
      <th>2023-12-27</th>
      <td>0.001808</td>
      <td>0.009398</td>
      <td>0.005998</td>
      <td>0.007590</td>
      <td>0.004190</td>
    </tr>
    <tr>
      <th>2023-12-28</th>
      <td>0.000378</td>
      <td>-0.001964</td>
      <td>0.005313</td>
      <td>-0.002342</td>
      <td>0.004935</td>
    </tr>
    <tr>
      <th>2023-12-29</th>
      <td>-0.002895</td>
      <td>0.000508</td>
      <td>-0.001174</td>
      <td>0.003403</td>
      <td>0.001721</td>
    </tr>
  </tbody>
</table>
<p>7785 rows × 5 columns</p>
</div></div></div>
</div>
<p>What is the trading interpretation in this case? What is the portfolio that yields the ‘ret_m_spy’ payoff?</p>
<p>What is the cost of implementing this portfolio? Say you want to have a 100 dollar exposure to it?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">statsmodels.api</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sm</span>


<span class="c1"># Function to add regression line and beta coefficient</span>

<span class="n">df_re</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;SPY&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;WMT_m_spy&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;SPY vs WMT&#39;</span><span class="p">)</span>

<span class="c1"># Scatter plot for SPY vs CSCO</span>
<span class="n">df_re</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;SPY&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;JPM_m_spy&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;SPY vs JPM&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/9b6f6f35f165e0f955d1e5c942a34b02c47b051dad2ef223941b4abc7b9d80f5.png" src="../../_images/9b6f6f35f165e0f955d1e5c942a34b02c47b051dad2ef223941b4abc7b9d80f5.png" />
</div>
</div>
<p>Did it work?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_re</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">,:]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ticker
SPY          1.000000
WMT          0.497637
JPM          0.704236
WMT_m_spy   -0.266299
JPM_m_spy    0.261074
Name: SPY, dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_re</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ticker
SPY          0.011813
WMT          0.016023
JPM          0.023062
WMT_m_spy    0.014418
JPM_m_spy    0.016962
dtype: float64
</pre></div>
</div>
</div>
</div>
<p>What is going on?</p>
<p>The “model” motivating our decomposition was</p>
<div class="math notranslate nohighlight">
\[ r=r-rf-f+f+rf\]</div>
<p>with the <span class="math notranslate nohighlight">\(r-f-rf\)</span> picking up the stock specific movement and <span class="math notranslate nohighlight">\(f\)</span> the common movement</p>
<p>But it seems that the residual still has factor exposure</p>
<ul class="simple">
<li><p>For stock 1, the residual is negatively correlated, so it seems tha we are taking out too much</p></li>
<li><p>For stock 2, it is still positive, so we are taking out too little</p></li>
<li><p>Taking out 1 dollar of factor exposure for each 1 dollar of stock exposure reduced the factor exposure and the asset volatilities, but we can do better</p></li>
</ul>
</section>
</section>
<section id="towards-a-factor-model">
<h2>Towards a factor Model<a class="headerlink" href="#towards-a-factor-model" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>First idea is that stocks might have different degree of co-movement</p></li>
<li><p>For example, Defensive stocks like utilities, supermarkets, and so on might not suffer as much as in recessions</p></li>
<li><p>Small stocks, stocks with high leverage and so one might particularly suffer during economic busts</p></li>
</ul>
<div class="math notranslate nohighlight">
\[(excess~return)=(intercept)+(stock~beta)*(factor~excess~return)+ (idio~risk)\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">statsmodels.api</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sm</span>

<span class="n">factor</span><span class="o">=</span><span class="s1">&#39;SPY&#39;</span>
<span class="n">asset</span><span class="o">=</span><span class="s1">&#39;WMT&#39;</span>    
<span class="n">X</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">df_re</span><span class="p">[</span><span class="n">factor</span><span class="p">])</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">df_re</span><span class="p">[</span><span class="n">asset</span><span class="p">],</span> <span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">intercept_wmt</span><span class="p">,</span> <span class="n">beta_wmt</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">params</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;beta of asset </span><span class="si">{</span><span class="n">asset</span><span class="si">}</span><span class="s1"> is </span><span class="si">{</span><span class="n">beta_wmt</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>


<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">df_re</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="p">(</span><span class="n">df_re</span><span class="p">[</span><span class="s1">&#39;WMT&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">beta_wmt</span><span class="o">*</span><span class="n">df_re</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">]))</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;SPY vs WMT Residuals&#39;</span><span class="p">)</span>

<span class="n">factor</span><span class="o">=</span><span class="s1">&#39;SPY&#39;</span>
<span class="n">asset</span><span class="o">=</span><span class="s1">&#39;JPM&#39;</span>    
<span class="n">X</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">df_re</span><span class="p">[</span><span class="n">factor</span><span class="p">])</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">df_re</span><span class="p">[</span><span class="n">asset</span><span class="p">],</span> <span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">intercept_jpm</span><span class="p">,</span> <span class="n">beta_jpm</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">params</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;beta of asset </span><span class="si">{</span><span class="n">asset</span><span class="si">}</span><span class="s1"> is </span><span class="si">{</span><span class="n">beta_jpm</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>


<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">df_re</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">df_re</span><span class="p">[</span><span class="s1">&#39;JPM&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">beta_jpm</span><span class="o">*</span><span class="n">df_re</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;SPY vs JPM Residuals&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>beta of asset WMT is 0.6749692108883036
the &quot;intercept&quot; of asset WMT is 0.04522121157501705 annualized
beta of asset JPM is 1.374860222270463
the &quot;intercept&quot; of asset JPM is 0.023283503662360792 annualized
</pre></div>
</div>
<img alt="../../_images/cd2bfda774b640a8e550dc284a479e0f7f9fd0d7a1610c5e6a387f845dfcd7fe.png" src="../../_images/cd2bfda774b640a8e550dc284a479e0f7f9fd0d7a1610c5e6a387f845dfcd7fe.png" />
</div>
</div>
<p>Did it work?</p>
<ul class="simple">
<li><p>With the regression we have a statistical decomposition</p></li>
<li><p>At least in sample, the regression guarantees that the stock specific component is completely orthogonal to the factor</p></li>
</ul>
<div class="math notranslate nohighlight">
\[stock~specific~component=(excess~return)-(stock~beta)*(factor~excess~return)\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_re</span><span class="p">[[</span><span class="s1">&#39;SPY&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">corrwith</span><span class="p">(</span><span class="n">df_re</span><span class="p">[</span><span class="s1">&#39;JPM&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">beta_jpm</span><span class="o">*</span><span class="n">df_re</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ticker
SPY    1.656269e-16
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_re</span><span class="p">[[</span><span class="s1">&#39;SPY&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">corrwith</span><span class="p">(</span><span class="n">df_re</span><span class="p">[</span><span class="s1">&#39;WMT&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">beta_wmt</span><span class="o">*</span><span class="n">df_re</span><span class="p">[</span><span class="s1">&#39;SPY&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ticker
SPY    5.141267e-17
dtype: float64
</pre></div>
</div>
</div>
</div>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(\beta\)</span> , that is beta, measures factor exposure and together with the factor variance, it tells us the amount of factor risk in the asset</p></li>
<li><p><span class="math notranslate nohighlight">\(\epsilon\)</span> is the idiossyncratic, non-factor risk component of the asset–all the risk that is leftover after we take out the co-movement with the factor</p></li>
<li><p>intercept is going to be very important</p></li>
<li><p>We will discuss this later in detail</p></li>
</ul>
<p>How do we estimate the amount of idiossyncratic risk?</p>
<p>How do we estimate the amount of systematic risk?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;the historical variance of asset </span><span class="si">{</span><span class="n">asset</span><span class="si">}</span><span class="s1"> idio risk is </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">resid</span><span class="o">.</span><span class="n">var</span><span class="p">()</span><span class="o">*</span><span class="mi">252</span><span class="si">}</span><span class="s1"> annualized&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;the historical standard deviation of asset </span><span class="si">{</span><span class="n">asset</span><span class="si">}</span><span class="s1"> idio risk is </span><span class="si">{</span><span class="n">model</span><span class="o">.</span><span class="n">resid</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">*</span><span class="mi">252</span><span class="o">**</span><span class="mf">0.5</span><span class="si">}</span><span class="s1"> annualized&#39;</span><span class="p">)</span>


<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;the historical variance of the market factor is </span><span class="si">{</span><span class="n">df_re</span><span class="o">.</span><span class="n">SPY</span><span class="o">.</span><span class="n">var</span><span class="p">()</span><span class="o">*</span><span class="mi">252</span><span class="si">}</span><span class="s1"> annualized&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;the historical standard deviation of the market factor is </span><span class="si">{</span><span class="n">df_re</span><span class="o">.</span><span class="n">SPY</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">*</span><span class="mi">252</span><span class="o">**</span><span class="mf">0.5</span><span class="si">}</span><span class="s1"> annualized&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>the historical variance of asset JPM idio risk is 0.06755883655421582 annualized
the historical standard deviation of asset JPM idio risk is 0.25992082747293616 annualized
the historical variance of the market factor is 0.035166377478007854 annualized
the historical standard deviation of the market factor is 0.18752700466334934 annualized
</pre></div>
</div>
</div>
</div>
<p>Can we say what share of the stock variance is due the market risk factor?</p>
<p>What is the calculation?</p>
<blockquote>
<div><h3 class="rubric" id="takeaways">Takeaways</h3>
<ul class="simple">
<li><p>How to construct returns from prices and dividends</p></li>
<li><p>How to use moments of the return distribution to think about what you expect in the future</p></li>
<li><p>We learn about risk-premiums</p></li>
<li><p>We learned how to decompose an asset risk into a factor component and an asset specific component</p></li>
<li><p>We learned how to decompose the amount of variance is coming from each of these componenents</p></li>
</ul>
</div></blockquote>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./chapters/Finance"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#what-is-a-return">What is a return?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#decomposing-returns">Decomposing Returns</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#striping-the-risk-free-rate">Striping the risk-free rate</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#risk-premiums">Risk Premiums</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#stripping-the-common-factor">Stripping the common factor</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#towards-a-factor-model">Towards a factor Model</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Alan Moreira
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2021 Creative Commons Attribution-ShareAlike 4.0 International (CC BY-SA 4.0).
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>