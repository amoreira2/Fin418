
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>10. Characteristic-Based Trading strategies &#8212; Quantitative Investing</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../_static/book.css?v=c2893119" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'chapters/Finance/crosssectionalequitystrategies';</script>
    <link rel="canonical" href="https://amoreira2.github.io/Fin418/chapters/Finance/crosssectionalequitystrategies.html" />
    <link rel="icon" href="../../_static/figuremain2.jpg"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="10.3. Signal Construction" href="Momentum.html" />
    <link rel="prev" title="9. Performance Evaluation" href="Performance_evaluation.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/figuremain2.jpg" class="logo__image only-light" alt="Quantitative Investing - Home"/>
    <script>document.write(`<img src="../../_static/figuremain2.jpg" class="logo__image only-dark" alt="Quantitative Investing - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <ul class="current nav bd-sidenav">
<li class="toctree-l1 has-children"><a class="reference internal" href="../01/what-is-quant-investing.html">1. What is Quantitative Investing?</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../01/statistical-techniques.html">1.1. Statistical Techniques</a></li>
<li class="toctree-l2"><a class="reference internal" href="../01/computational-tools.html">1.2. Computational tools</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../02/getting_started.html">2. Getting Started</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../02/local_install.html">2.3. Local installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../02/cloud_setup.html">2.4. Cloud Setup</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../essentials/intro.html">3. Python Essentials</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../essentials/basics.html">3.1. Basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../essentials/collections.html">3.2. Collections</a></li>
<li class="toctree-l2"><a class="reference internal" href="../essentials/numpy.html">3.3. Numpy</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../essentials/introtopandas.html">3.4. Pandas</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l3"><a class="reference internal" href="../essentials/pandas/the_index.html">3.4.3. Indexing</a></li>
<li class="toctree-l3"><a class="reference internal" href="../essentials/pandas/timeseries.html">3.4.4. Time-Series</a></li>
<li class="toctree-l3"><a class="reference internal" href="../essentials/pandas/reshape.html">3.4.5. Reshape</a></li>
<li class="toctree-l3"><a class="reference internal" href="../essentials/pandas/merge.html">3.4.6. Merge</a></li>
<li class="toctree-l3"><a class="reference internal" href="../essentials/pandas/groupby.html">3.4.7. Group-by</a></li>
<li class="toctree-l3"><a class="reference internal" href="../essentials/pandas/matplotlib.html">3.4.8. Plotting</a></li>
<li class="toctree-l3"><a class="reference internal" href="../essentials/pandas/data_clean.html">3.4.9. Cleaning data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../essentials/pandas/storage_formats.html">3.4.10. Data Storage</a></li>
</ul>
</details></li>
<li class="toctree-l2"><a class="reference internal" href="../essentials/control_flow.html">3.5. Flow control</a></li>
<li class="toctree-l2"><a class="reference internal" href="../essentials/functions.html">3.6. Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../essentials/plotting.html">3.7. Plotting</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="Returns_working.html">4. Asset Returns</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="UsingAPI.html">4.5. Data APIs</a></li>
<li class="toctree-l2"><a class="reference internal" href="TheChoiceofFrequency.html">4.6. The Choice of Frequency and Annualization of Returns</a></li>
<li class="toctree-l2"><a class="reference internal" href="../scientific/randomness1.html">4.7. Modeling randomness</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="FactorModels.html">5. Factor Models</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="PortfolioMath.html">6. Portfolios</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="LeverageandShorting.html">6.8. Leverage and Shorting</a></li>
<li class="toctree-l2"><a class="reference internal" href="../scientific/linear_algebra1.html">6.9. Linear Algebra Review</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="FactorModelEstimation.html">7. Factor Model Estimation</a></li>
<li class="toctree-l1"><a class="reference internal" href="CapitalAllocation.html">8. Capital Allocation</a></li>
<li class="toctree-l1"><a class="reference internal" href="Performance_evaluation.html">9. Performance Evaluation</a></li>
<li class="toctree-l1 current active has-children"><a class="current reference internal" href="#">10. Cross-Sectional Equity Strategies</a><details open="open"><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="Momentum.html">10.3. Momentum factor</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="MultiFactorModels.html">11. Multi Factor Models</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="Factors.html">11.9. An overview of factors</a></li>
<li class="toctree-l2"><a class="reference internal" href="InterpretingFactorModels.html">11.10. Interpreting Factor Models</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="MachineLearning.html">12. Machine Learning in Finance</a></li>
<li class="toctree-l1"><a class="reference internal" href="../additional/additional.html">13. Additional Statistics Material</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../Assignments/Assignments.html">14. Assignments</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../Assignments/Assignment0.html">14.1. Assigment 0</a></li>




<li class="toctree-l2"><a class="reference internal" href="../Assignments/Assignment1.html">14.6. Assignment 1</a></li>


<li class="toctree-l2"><a class="reference internal" href="../Assignments/Assignment2.html">14.9. Assignment 2</a></li>


<li class="toctree-l2"><a class="reference internal" href="../Assignments/Assignment3.html">14.12. Assignment 3</a></li>


<li class="toctree-l2"><a class="reference internal" href="../Assignments/Assignment4.html">14.15. Assignment 4</a></li>


</ul>
</details></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/amoreira2/Fin418/blob/main/chapters/Finance/crosssectionalequitystrategies.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Colab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Colab logo" src="../../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/amoreira2/Fin418" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/amoreira2/Fin418/issues/new?title=Issue%20on%20page%20%2Fchapters/Finance/crosssectionalequitystrategies.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/chapters/Finance/crosssectionalequitystrategies.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Characteristic-Based Trading strategies</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-market-cap-weighted-strategy">10.1. The Market-Cap Weighted strategy</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#factor-construction-implementing-the-recipe">10.2. Factor Construction: Implementing the recipe</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#what-are-these-characteristics">10.2.1. What are these characteristics?</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <div class="cell tag_hide-cell docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell content</span>
<span class="expanded">Hide code cell content</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span><span class="w"> </span><span class="nn">wrds</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas_datareader.data</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">web</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_factors</span><span class="p">(</span><span class="n">factors</span><span class="o">=</span><span class="s1">&#39;CAPM&#39;</span><span class="p">,</span><span class="n">freq</span><span class="o">=</span><span class="s1">&#39;daily&#39;</span><span class="p">):</span>   
    
    <span class="k">if</span> <span class="n">freq</span><span class="o">==</span><span class="s1">&#39;monthly&#39;</span><span class="p">:</span>
        <span class="n">freq_label</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">freq_label</span><span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">freq</span>


    <span class="k">if</span> <span class="n">factors</span><span class="o">==</span><span class="s1">&#39;CAPM&#39;</span><span class="p">:</span>
        <span class="n">fama_french</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="s2">&quot;F-F_Research_Data_Factors&quot;</span><span class="o">+</span><span class="n">freq_label</span><span class="p">,</span> <span class="s2">&quot;famafrench&quot;</span><span class="p">,</span><span class="n">start</span><span class="o">=</span><span class="s2">&quot;1921-01-01&quot;</span><span class="p">)</span>
        <span class="n">daily_data</span> <span class="o">=</span> <span class="n">fama_french</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
     
        <span class="n">df_factor</span> <span class="o">=</span> <span class="n">daily_data</span><span class="p">[[</span><span class="s1">&#39;RF&#39;</span><span class="p">,</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">]]</span> 
    <span class="k">elif</span> <span class="n">factors</span><span class="o">==</span><span class="s1">&#39;FF3&#39;</span><span class="p">:</span>
        <span class="n">fama_french</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="s2">&quot;F-F_Research_Data_Factors&quot;</span><span class="o">+</span><span class="n">freq_label</span><span class="p">,</span> <span class="s2">&quot;famafrench&quot;</span><span class="p">,</span><span class="n">start</span><span class="o">=</span><span class="s2">&quot;1921-01-01&quot;</span><span class="p">)</span>
        <span class="n">daily_data</span> <span class="o">=</span> <span class="n">fama_french</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">df_factor</span> <span class="o">=</span> <span class="n">daily_data</span><span class="p">[[</span><span class="s1">&#39;RF&#39;</span><span class="p">,</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">,</span><span class="s1">&#39;SMB&#39;</span><span class="p">,</span><span class="s1">&#39;HML&#39;</span><span class="p">]]</span>
    <span class="k">elif</span> <span class="n">factors</span><span class="o">==</span><span class="s1">&#39;FF5&#39;</span><span class="p">:</span>

        <span class="n">fama_french</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="s2">&quot;F-F_Research_Data_Factors&quot;</span><span class="o">+</span><span class="n">freq_label</span><span class="p">,</span> <span class="s2">&quot;famafrench&quot;</span><span class="p">,</span><span class="n">start</span><span class="o">=</span><span class="s2">&quot;1921-01-01&quot;</span><span class="p">)</span>
        <span class="n">daily_data</span> <span class="o">=</span> <span class="n">fama_french</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">df_factor</span> <span class="o">=</span> <span class="n">daily_data</span><span class="p">[[</span><span class="s1">&#39;RF&#39;</span><span class="p">,</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">,</span><span class="s1">&#39;SMB&#39;</span><span class="p">,</span><span class="s1">&#39;HML&#39;</span><span class="p">]]</span>
        <span class="n">fama_french2</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="s2">&quot;F-F_Research_Data_5_Factors_2x3&quot;</span><span class="o">+</span><span class="n">freq_label</span><span class="p">,</span> <span class="s2">&quot;famafrench&quot;</span><span class="p">,</span><span class="n">start</span><span class="o">=</span><span class="s2">&quot;1921-01-01&quot;</span><span class="p">)</span>
        <span class="n">daily_data2</span> <span class="o">=</span> <span class="n">fama_french2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">df_factor2</span> <span class="o">=</span> <span class="n">daily_data2</span><span class="p">[[</span><span class="s1">&#39;RMW&#39;</span><span class="p">,</span><span class="s1">&#39;CMA&#39;</span><span class="p">]]</span>
        <span class="n">df_factor</span><span class="o">=</span><span class="n">df_factor</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_factor2</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>    
        
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fama_french</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="s2">&quot;F-F_Research_Data_Factors&quot;</span><span class="o">+</span><span class="n">freq_label</span><span class="p">,</span> <span class="s2">&quot;famafrench&quot;</span><span class="p">,</span><span class="n">start</span><span class="o">=</span><span class="s2">&quot;1921-01-01&quot;</span><span class="p">)</span>
        <span class="n">daily_data</span> <span class="o">=</span> <span class="n">fama_french</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">df_factor</span> <span class="o">=</span> <span class="n">daily_data</span><span class="p">[[</span><span class="s1">&#39;RF&#39;</span><span class="p">,</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">,</span><span class="s1">&#39;SMB&#39;</span><span class="p">,</span><span class="s1">&#39;HML&#39;</span><span class="p">]]</span>
        <span class="n">fama_french2</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="s2">&quot;F-F_Research_Data_5_Factors_2x3&quot;</span><span class="o">+</span><span class="n">freq_label</span><span class="p">,</span> <span class="s2">&quot;famafrench&quot;</span><span class="p">,</span><span class="n">start</span><span class="o">=</span><span class="s2">&quot;1921-01-01&quot;</span><span class="p">)</span>
        <span class="n">daily_data2</span> <span class="o">=</span> <span class="n">fama_french2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">df_factor2</span> <span class="o">=</span> <span class="n">daily_data2</span><span class="p">[[</span><span class="s1">&#39;RMW&#39;</span><span class="p">,</span><span class="s1">&#39;CMA&#39;</span><span class="p">]]</span>
        <span class="n">df_factor</span><span class="o">=</span><span class="n">df_factor</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_factor2</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>   
        <span class="n">fama_french</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">DataReader</span><span class="p">(</span><span class="s2">&quot;F-F_Momentum_Factor&quot;</span><span class="o">+</span><span class="n">freq_label</span><span class="p">,</span> <span class="s2">&quot;famafrench&quot;</span><span class="p">,</span><span class="n">start</span><span class="o">=</span><span class="s2">&quot;1921-01-01&quot;</span><span class="p">)</span>
        <span class="n">df_factor</span><span class="o">=</span><span class="n">df_factor</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">fama_french</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">on</span><span class="o">=</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
        <span class="n">df_factor</span><span class="o">.</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">,</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">,</span><span class="s1">&#39;SMB&#39;</span><span class="p">,</span><span class="s1">&#39;HML&#39;</span><span class="p">,</span><span class="s1">&#39;RMW&#39;</span><span class="p">,</span><span class="s1">&#39;CMA&#39;</span><span class="p">,</span><span class="s1">&#39;MOM&#39;</span><span class="p">]</span>    
    <span class="k">if</span> <span class="n">freq</span><span class="o">==</span><span class="s1">&#39;monthly&#39;</span><span class="p">:</span>
        <span class="n">df_factor</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_factor</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_timestamp</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df_factor</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df_factor</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        


    <span class="k">return</span> <span class="n">df_factor</span><span class="o">/</span><span class="mi">100</span>
</pre></div>
</div>
</div>
</details>
</div>
<section class="tex2jax_ignore mathjax_ignore" id="characteristic-based-trading-strategies">
<h1><span class="section-number">10. </span>Characteristic-Based Trading strategies<a class="headerlink" href="#characteristic-based-trading-strategies" title="Link to this heading">#</a></h1>
<ul class="simple">
<li><p>So far we have looked at strategies that go in and out of a particular asset according to a signal.</p></li>
<li><p>We looked at past average returns, past  volatility, and past co-variances</p></li>
<li><p>Now we will look at strategies that trade of asset characteristics</p></li>
<li><p>A characteristic is anything that you can associate to a particular stock</p></li>
<li><p>Past average returns, past volatility are types of charateristics</p></li>
<li><p>but it is much more general than that</p></li>
</ul>
<p><strong>The  recipe</strong></p>
<ol class="arabic simple">
<li><p>Construct a characteristic for each stock.</p>
<ul class="simple">
<li><p>It can be based on accounting data, return data, textual data from earning calls, twitter activity, ownership, shorting activity, satellite images–</p></li>
<li><p>You can do for anything</p></li>
<li><p>What is important is that for each stock in each date you have a value for this characteristic</p></li>
</ul>
</li>
<li><p>On a given date sort stocks by this characteristic.</p>
<ul class="simple">
<li><p>It is key that this characteristic is in fact known at sorting date!</p></li>
<li><p>Extremely careful not to introduce “look-ahead” bias</p></li>
</ul>
</li>
<li><p>Construct portfolios by dividing stocks in deciles/quintiles and form portfolios of stocks that have similar characteristic</p>
<ul class="simple">
<li><p>You can either equal weight or value weight within portfolio</p></li>
<li><p>Value-weighed portfolios are easier to trade, but if you are focused on large caps, you can go with either</p></li>
<li><p>But what is important is that each portfolio will have stocks of have very different characteristic values</p></li>
</ul>
</li>
<li><p>Construct the long-short where you go long portfolio 10 and short portfolio 1 (or vice versa) but the point is to take a bet on the characteristic spread</p></li>
</ol>
<blockquote>
<div><p><strong>But the goal here is to produce alpha</strong></p>
<ul class="simple">
<li><p>this is a simply and algorithimic  way to implement your idea in a way that harvest the benefits of diversification</p></li>
<li><p>Instead of betting on Tesla because Musk is close to trump, build a trump connection “characteristic”</p></li>
<li><p>How exactly? Now sure…but I am sure someone is thinking…</p></li>
<li><p>What are potential characteristcs that might be interesting right now in 2025 with a new administration?</p></li>
</ul>
</div></blockquote>
<p><strong>Quantitative investing is going from “names”  to characteristics</strong></p>
<ul class="simple">
<li><p>The  sorting by date keeps the stocks inside the portfolios with similar characteristics</p></li>
<li><p>This sorting will “work” if these chracteristics are good proxies for the behavior of the stock returns</p></li>
<li><p>Indeed, the key is that each portfolio has stocks of vastly different characterisitcs and keeps churning as firms change</p>
<ul>
<li><p>Let’s take MSFT (microsoft) as an example:</p></li>
<li><p>MSFT transitioned from being small in the 80’s to be gigantic in the 90’s, as a result, it moved up from the small portfolio to the big portfolio</p></li>
<li><p>During the Tech boom when MSFT had a huge valuation relative to it’s book value, it went to the low BM portfolio</p></li>
<li><p>But then MSFT transtioned back to the high BM portfolio once it’s market valuation collapsed in the aftermath of the techbubble</p></li>
<li><p>Now with AI, MSFT is back into the low BM portfolio</p></li>
<li><p>During these 80 years MSFT changed dramatically and the characteristic changed with it…</p></li>
</ul>
</li>
<li><p>The key is that firms’ characteristics change over time, by constructing  portfolios, we hope to estimate some stable parameters (for example, alpha and beta)</p></li>
<li><p>But it doesn’t work always, if you use the first letter of stock ticker to construct 26 portfolios you are unlikely to get spread in average returns and most likely each portfolio will resemble the market portfolio but with much more volatility.</p></li>
</ul>
<blockquote>
<div><h3 class="rubric" id="large-data">Large Data</h3>
<ul class="simple">
<li><p>We will now work with large data sets</p></li>
<li><p>Data sets that include all US stocks</p></li>
<li><p>Because there are many stocks, we have to work with it stacked</p></li>
<li><p>As a warm up for you first factor construction we will construct the returns on the market portfolio</p></li>
</ul>
</div></blockquote>
<section id="the-market-cap-weighted-strategy">
<h2><span class="section-number">10.1. </span>The Market-Cap Weighted strategy<a class="headerlink" href="#the-market-cap-weighted-strategy" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>start with a vector of market capitalization for all relevant assets <span class="math notranslate nohighlight">\(M_t=[m_t^{AAPL},m_t^{GOOG},m_t^{TSLA},..]\)</span></p></li>
</ul>
<div class="math notranslate nohighlight">
\[m_t^{AAPL}=P^{AAPL}_t\times SharesOutstanding^{AAPL}\]</div>
<p>The strategy then set the weights simply to</p>
<div class="math notranslate nohighlight">
\[X_t=\frac{M_t}{\sum_i^Im^i_t}\]</div>
<p>So at end of month <strong>t</strong> you look at the market caps, construct the weights, and buy the assets with weights <span class="math notranslate nohighlight">\(X_t\)</span> to earn</p>
<div class="math notranslate nohighlight">
\[R^{mcap}_{t+1}=X_tR_{t+1}\]</div>
<p>at the end of the next month.</p>
<p>This portfolio has nice properties</p>
<ol class="arabic simple">
<li><p>This portfolio is very easy to trade. It does not require re-balancing as you weights naturally go up if the stock rallies and go down if the stock crashes</p></li>
<li><p>You can implement this approach to any subset of firms (for example SP500 or Russel2000) are market cap indexes that track a particular universe of stocks and we will be using it in our characteristic-based portfolios shortly</p></li>
<li><p>By buying proportionally to market cap you never have to build a huge position in a tiny stock</p></li>
</ol>
<blockquote>
<div><p><strong>Steps</strong></p>
<ol class="arabic simple">
<li><p>Get firm level monthly return data with market capitalizations</p></li>
<li><p>clean up/organize the data set</p></li>
<li><p>Make sure to lag the market cap signal so that we use prices from last month to trade at the start of this month ( we could also skip another month to be extra sure)</p></li>
<li><p>Construct the weighted average of returns across stocks for each date</p></li>
</ol>
</div></blockquote>
<p><strong>Organizing the data</strong></p>
<p>The objective here is to have a data set with</p>
<ul class="simple">
<li><p>Security identifier</p></li>
<li><p>Date of the information</p></li>
<li><p>Monthly return of the firm in that month</p></li>
<li><p>Market capitalization of the firm in that month</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="ch">#!pip install wrds</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">dt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">wrds</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">psycopg2</span> 
<span class="kn">from</span><span class="w"> </span><span class="nn">dateutil.relativedelta</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pandas.tseries.offsets</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>

<span class="c1">###################</span>
<span class="n">conn</span><span class="o">=</span><span class="n">wrds</span><span class="o">.</span><span class="n">Connection</span><span class="p">()</span> 


<span class="n">crsp</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">raw_sql</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                      select a.permno,a.permco, a.date, b.shrcd, b.exchcd,b.ticker,</span>
<span class="s2">                      a.ret, a.shrout, a.prc,a.retx</span>
<span class="s2">                      from crsp.msf as a</span>
<span class="s2">                      left join crsp.msenames as b</span>
<span class="s2">                      on a.permno=b.permno</span>
<span class="s2">                      and b.namedt&lt;=a.date</span>
<span class="s2">                      and a.date&lt;=b.nameendt</span>
<span class="s2">                      where a.date between &#39;01/31/1990&#39; and &#39;12/31/2019&#39;</span>
<span class="s2">                      and b.exchcd between 1 and 3</span>
<span class="s2">                      and b.shrcd between 10 and 11</span>
<span class="s2">                      &quot;&quot;&quot;</span><span class="p">,</span> <span class="n">date_cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">])</span> 


<span class="c1"># this saves it</span>
<span class="c1">#crsp_m.to_pickle(&#39;../../assets/data/crspm2005_2020.pkl&#39;)</span>
<span class="c1"># variables downloaded</span>

<span class="c1"># 1. Permno-- are unique indentifier to a security </span>
<span class="c1"># (for exmaple a stock that has multiple types of stocks will have multiple permnos)</span>

<span class="c1"># 2. shrco is the type of share: common share, ADR, ETF, ....</span>
<span class="c1"># we will focus on common shares</span>

<span class="c1"># 3. exchcd is the code of the exchange where the stock was originally listed</span>
<span class="c1"># we will focus on stock listed in the 3 major stock exchanges ( basically the whole market)</span>

<span class="c1"># 4. ret,retx, shrout,  prc, are the stock return, the stock return excluding dividends, number of shares outstanding, and price</span>

<span class="c1"># 5. date is the trading date of the return</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WRDS recommends setting up a .pgpass file.
Created .pgpass file successfully.
You can create this file yourself at any time with the create_pgpass_file() function.
Loading library list...
Done
</pre></div>
</div>
</div>
</div>
<hr class="docutils" />
<p><em>If you don’t want to deal with that you can simply get the data by running the code below</em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">crsp</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="s1">&#39;https://github.com/amoreira2/Fin418/blob/main/assets/data/crspm2005_2020.pkl?raw=true&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pandas.tseries.offsets</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="n">crsp</span><span class="o">=</span><span class="n">crsp</span><span class="p">[[</span><span class="s1">&#39;permco&#39;</span><span class="p">,</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span><span class="s1">&#39;ticker&#39;</span><span class="p">,</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;ret&#39;</span><span class="p">,</span><span class="s1">&#39;shrout&#39;</span><span class="p">,</span><span class="s1">&#39;prc&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="c1"># change variable format to int</span>
<span class="n">crsp</span><span class="p">[[</span><span class="s1">&#39;permno&#39;</span><span class="p">]]</span><span class="o">=</span><span class="n">crsp</span><span class="p">[[</span><span class="s1">&#39;permno&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">crsp</span><span class="p">[[</span><span class="s1">&#39;permco&#39;</span><span class="p">]]</span><span class="o">=</span><span class="n">crsp</span><span class="p">[[</span><span class="s1">&#39;permco&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="c1"># Line up date to be end of month </span>
<span class="n">crsp</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">crsp</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">MonthEnd</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># calculate market equity</span>
<span class="c1"># why do we use absolute value of price?</span>
<span class="n">crsp</span><span class="p">[</span><span class="s1">&#39;me&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">crsp</span><span class="p">[</span><span class="s1">&#39;prc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">*</span><span class="n">crsp</span><span class="p">[</span><span class="s1">&#39;shrout&#39;</span><span class="p">]</span> 
<span class="c1"># drop price and shareoustandng since we won&#39;t need it anymore</span>
<span class="n">crsp</span><span class="o">=</span><span class="n">crsp</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;prc&#39;</span><span class="p">,</span><span class="s1">&#39;shrout&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">crsp_me</span><span class="o">=</span><span class="n">crsp</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;permco&#39;</span><span class="p">])[</span><span class="s1">&#39;me&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>


<span class="c1"># largest mktcap within a permco/date</span>
<span class="n">crsp_maxme</span> <span class="o">=</span> <span class="n">crsp</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;permco&#39;</span><span class="p">])[</span><span class="s1">&#39;me&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

<span class="c1"># join by jdate/maxme to find the permno</span>
<span class="n">crsp</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">crsp</span><span class="p">,</span> <span class="n">crsp_maxme</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;permco&#39;</span><span class="p">,</span><span class="s1">&#39;me&#39;</span><span class="p">])</span>

<span class="c1"># drop me column and replace with the sum me</span>
<span class="n">crsp</span><span class="o">=</span><span class="n">crsp</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;me&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># join with sum of me to get the correct market cap info</span>
<span class="n">crsp</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">crsp</span><span class="p">,</span> <span class="n">crsp_me</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;permco&#39;</span><span class="p">])</span>

<span class="c1"># sort by permno and date and also drop duplicates</span>
<span class="n">crsp</span><span class="o">=</span><span class="n">crsp</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span><span class="s1">&#39;date&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>

<span class="n">crsp</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>permco</th>
      <th>permno</th>
      <th>ticker</th>
      <th>date</th>
      <th>ret</th>
      <th>me</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>4536</th>
      <td>7953</td>
      <td>10001</td>
      <td>GFGC</td>
      <td>1990-01-31</td>
      <td>-0.018519</td>
      <td>10156.125</td>
    </tr>
    <tr>
      <th>4537</th>
      <td>7953</td>
      <td>10001</td>
      <td>GFGC</td>
      <td>1990-02-28</td>
      <td>-0.006289</td>
      <td>10092.250</td>
    </tr>
    <tr>
      <th>4538</th>
      <td>7953</td>
      <td>10001</td>
      <td>GFGC</td>
      <td>1990-03-31</td>
      <td>0.012658</td>
      <td>10141.625</td>
    </tr>
    <tr>
      <th>4539</th>
      <td>7953</td>
      <td>10001</td>
      <td>GFGC</td>
      <td>1990-04-30</td>
      <td>0.000000</td>
      <td>10141.625</td>
    </tr>
    <tr>
      <th>4540</th>
      <td>7953</td>
      <td>10001</td>
      <td>GFGC</td>
      <td>1990-05-31</td>
      <td>-0.012658</td>
      <td>10013.250</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<blockquote>
<div><h3 class="rubric" id="take-time-to-note-the-stacked-structure-of-the-data-set">Take time to note the stacked structure of the data set</h3>
<ul class="simple">
<li><p>Before with a “rectangular” data set  we need two coordinates, row and column, to identify the return of an asset in a particular date</p></li>
<li><p>It was easier to manipulate but we would need one dataframe for each different firm variable: In this case one for return and one for market equity</p></li>
<li><p>As we work with many signals, this becomes intractable because we would need many dataframes</p></li>
<li><p>As we work with many asset, this would become intractable because we would need dataframes with many columns with most locations empty. This is very inefficient and hard to manipulate</p></li>
</ul>
<h3 class="rubric" id="stacked-data-sets">Stacked data sets</h3>
<ul class="simple">
<li><p>Now we need two coordinates both in columns, “date” and “permco”, to identify one firm-date observation, and then a third coordinate, the column names to identify the particular variable for that firm-date pair</p></li>
</ul>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">crsp</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">325</span><span class="p">:</span><span class="mi">340</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>permco</th>
      <th>permno</th>
      <th>date</th>
      <th>ret</th>
      <th>me</th>
      <th>me_l1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>3644</th>
      <td>7953</td>
      <td>10001</td>
      <td>2017-02-28</td>
      <td>0.000000</td>
      <td>133078.000</td>
      <td>133078.000</td>
    </tr>
    <tr>
      <th>3645</th>
      <td>7953</td>
      <td>10001</td>
      <td>2017-03-31</td>
      <td>0.009881</td>
      <td>133604.000</td>
      <td>133078.000</td>
    </tr>
    <tr>
      <th>3646</th>
      <td>7953</td>
      <td>10001</td>
      <td>2017-04-30</td>
      <td>-0.015748</td>
      <td>131500.000</td>
      <td>133604.000</td>
    </tr>
    <tr>
      <th>3647</th>
      <td>7953</td>
      <td>10001</td>
      <td>2017-05-31</td>
      <td>0.016000</td>
      <td>133604.000</td>
      <td>131500.000</td>
    </tr>
    <tr>
      <th>3648</th>
      <td>7953</td>
      <td>10001</td>
      <td>2017-06-30</td>
      <td>0.023622</td>
      <td>135971.000</td>
      <td>133604.000</td>
    </tr>
    <tr>
      <th>3649</th>
      <td>7953</td>
      <td>10001</td>
      <td>2017-07-31</td>
      <td>0.001934</td>
      <td>136234.000</td>
      <td>135971.000</td>
    </tr>
    <tr>
      <th>3650</th>
      <td>7954</td>
      <td>10002</td>
      <td>1990-01-31</td>
      <td>0.020408</td>
      <td>7343.750</td>
      <td>136234.000</td>
    </tr>
    <tr>
      <th>3651</th>
      <td>7954</td>
      <td>10002</td>
      <td>1990-02-28</td>
      <td>0.020000</td>
      <td>7490.625</td>
      <td>7343.750</td>
    </tr>
    <tr>
      <th>3652</th>
      <td>7954</td>
      <td>10002</td>
      <td>1990-03-31</td>
      <td>0.000000</td>
      <td>7490.625</td>
      <td>7490.625</td>
    </tr>
    <tr>
      <th>3653</th>
      <td>7954</td>
      <td>10002</td>
      <td>1990-04-30</td>
      <td>0.000000</td>
      <td>7490.625</td>
      <td>7490.625</td>
    </tr>
    <tr>
      <th>3654</th>
      <td>7954</td>
      <td>10002</td>
      <td>1990-05-31</td>
      <td>0.000000</td>
      <td>7490.625</td>
      <td>7490.625</td>
    </tr>
    <tr>
      <th>3655</th>
      <td>7954</td>
      <td>10002</td>
      <td>1990-06-30</td>
      <td>0.000000</td>
      <td>7490.625</td>
      <td>7490.625</td>
    </tr>
    <tr>
      <th>3656</th>
      <td>7954</td>
      <td>10002</td>
      <td>1990-07-31</td>
      <td>-0.039216</td>
      <td>7196.875</td>
      <td>7490.625</td>
    </tr>
    <tr>
      <th>3657</th>
      <td>7954</td>
      <td>10002</td>
      <td>1990-08-31</td>
      <td>-0.040816</td>
      <td>6903.125</td>
      <td>7196.875</td>
    </tr>
    <tr>
      <th>3658</th>
      <td>7954</td>
      <td>10002</td>
      <td>1990-09-30</td>
      <td>-0.127660</td>
      <td>6021.875</td>
      <td>6903.125</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<blockquote>
<div><p><strong>Lagging the market cap signal</strong></p>
<ul class="simple">
<li><p>We use the method <code class="docutils literal notranslate"><span class="pre">.shift(d)</span></code> which “lags” the data by d periods.</p></li>
<li><p>It is important that we have our data set sorted by date</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">shift(d)</span></code> simply shifts the rows. So you have to make sure that it is actually lagging by date.</p></li>
</ul>
<p>The way to do that is to  <code class="docutils literal notranslate"><span class="pre">groupby</span></code> security and applying the shift within security.</p>
</div></blockquote>
<blockquote>
<div><p>Why this is important?</p>
<ul class="simple">
<li><p>Because the data set is stacked so when you shift the first month of security n, it will end up returning the last month of security n-1.</p></li>
<li><p>By “grouping by” we correctly assign a missing value there since we don’t have the data</p></li>
</ul>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># sort by permno and date and set as index</span>
<span class="n">crsp</span><span class="o">=</span><span class="n">crsp</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;permno&#39;</span><span class="p">,</span><span class="s1">&#39;date&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># done incorrectly</span>
<span class="n">crsp</span><span class="p">[</span><span class="s1">&#39;me_l1&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">crsp</span><span class="o">.</span><span class="n">me</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">crsp</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">325</span><span class="p">:</span><span class="mi">340</span><span class="p">]</span>
<span class="c1"># what is the problem  here?</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>permco</th>
      <th>permno</th>
      <th>date</th>
      <th>ret</th>
      <th>me</th>
      <th>me_l1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>3644</th>
      <td>7953</td>
      <td>10001</td>
      <td>2017-02-28</td>
      <td>0.000000</td>
      <td>133078.000</td>
      <td>133078.000</td>
    </tr>
    <tr>
      <th>3645</th>
      <td>7953</td>
      <td>10001</td>
      <td>2017-03-31</td>
      <td>0.009881</td>
      <td>133604.000</td>
      <td>133078.000</td>
    </tr>
    <tr>
      <th>3646</th>
      <td>7953</td>
      <td>10001</td>
      <td>2017-04-30</td>
      <td>-0.015748</td>
      <td>131500.000</td>
      <td>133604.000</td>
    </tr>
    <tr>
      <th>3647</th>
      <td>7953</td>
      <td>10001</td>
      <td>2017-05-31</td>
      <td>0.016000</td>
      <td>133604.000</td>
      <td>131500.000</td>
    </tr>
    <tr>
      <th>3648</th>
      <td>7953</td>
      <td>10001</td>
      <td>2017-06-30</td>
      <td>0.023622</td>
      <td>135971.000</td>
      <td>133604.000</td>
    </tr>
    <tr>
      <th>3649</th>
      <td>7953</td>
      <td>10001</td>
      <td>2017-07-31</td>
      <td>0.001934</td>
      <td>136234.000</td>
      <td>135971.000</td>
    </tr>
    <tr>
      <th>3650</th>
      <td>7954</td>
      <td>10002</td>
      <td>1990-01-31</td>
      <td>0.020408</td>
      <td>7343.750</td>
      <td>136234.000</td>
    </tr>
    <tr>
      <th>3651</th>
      <td>7954</td>
      <td>10002</td>
      <td>1990-02-28</td>
      <td>0.020000</td>
      <td>7490.625</td>
      <td>7343.750</td>
    </tr>
    <tr>
      <th>3652</th>
      <td>7954</td>
      <td>10002</td>
      <td>1990-03-31</td>
      <td>0.000000</td>
      <td>7490.625</td>
      <td>7490.625</td>
    </tr>
    <tr>
      <th>3653</th>
      <td>7954</td>
      <td>10002</td>
      <td>1990-04-30</td>
      <td>0.000000</td>
      <td>7490.625</td>
      <td>7490.625</td>
    </tr>
    <tr>
      <th>3654</th>
      <td>7954</td>
      <td>10002</td>
      <td>1990-05-31</td>
      <td>0.000000</td>
      <td>7490.625</td>
      <td>7490.625</td>
    </tr>
    <tr>
      <th>3655</th>
      <td>7954</td>
      <td>10002</td>
      <td>1990-06-30</td>
      <td>0.000000</td>
      <td>7490.625</td>
      <td>7490.625</td>
    </tr>
    <tr>
      <th>3656</th>
      <td>7954</td>
      <td>10002</td>
      <td>1990-07-31</td>
      <td>-0.039216</td>
      <td>7196.875</td>
      <td>7490.625</td>
    </tr>
    <tr>
      <th>3657</th>
      <td>7954</td>
      <td>10002</td>
      <td>1990-08-31</td>
      <td>-0.040816</td>
      <td>6903.125</td>
      <td>7196.875</td>
    </tr>
    <tr>
      <th>3658</th>
      <td>7954</td>
      <td>10002</td>
      <td>1990-09-30</td>
      <td>-0.127660</td>
      <td>6021.875</td>
      <td>6903.125</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">crsp</span><span class="p">[</span><span class="s1">&#39;me_l1&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">crsp</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;permno&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">me</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">crsp</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">325</span><span class="p">:</span><span class="mi">340</span><span class="p">]</span>
<span class="c1"># did it get fixed?</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>permco</th>
      <th>permno</th>
      <th>ticker</th>
      <th>date</th>
      <th>ret</th>
      <th>me</th>
      <th>me_l1</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>4861</th>
      <td>7953</td>
      <td>10001</td>
      <td>EGAS</td>
      <td>2017-02-28</td>
      <td>0.000000</td>
      <td>133078.000</td>
      <td>133078.000</td>
    </tr>
    <tr>
      <th>4862</th>
      <td>7953</td>
      <td>10001</td>
      <td>EGAS</td>
      <td>2017-03-31</td>
      <td>0.009881</td>
      <td>133604.000</td>
      <td>133078.000</td>
    </tr>
    <tr>
      <th>4863</th>
      <td>7953</td>
      <td>10001</td>
      <td>EGAS</td>
      <td>2017-04-30</td>
      <td>-0.015748</td>
      <td>131500.000</td>
      <td>133604.000</td>
    </tr>
    <tr>
      <th>4864</th>
      <td>7953</td>
      <td>10001</td>
      <td>EGAS</td>
      <td>2017-05-31</td>
      <td>0.016000</td>
      <td>133604.000</td>
      <td>131500.000</td>
    </tr>
    <tr>
      <th>4865</th>
      <td>7953</td>
      <td>10001</td>
      <td>EGAS</td>
      <td>2017-06-30</td>
      <td>0.023622</td>
      <td>135971.000</td>
      <td>133604.000</td>
    </tr>
    <tr>
      <th>4866</th>
      <td>7953</td>
      <td>10001</td>
      <td>EGAS</td>
      <td>2017-07-31</td>
      <td>0.001934</td>
      <td>136234.000</td>
      <td>135971.000</td>
    </tr>
    <tr>
      <th>4867</th>
      <td>7954</td>
      <td>10002</td>
      <td>MBNC</td>
      <td>1990-01-31</td>
      <td>0.020408</td>
      <td>7343.750</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4868</th>
      <td>7954</td>
      <td>10002</td>
      <td>MBNC</td>
      <td>1990-02-28</td>
      <td>0.020000</td>
      <td>7490.625</td>
      <td>7343.750</td>
    </tr>
    <tr>
      <th>4869</th>
      <td>7954</td>
      <td>10002</td>
      <td>MBNC</td>
      <td>1990-03-31</td>
      <td>0.000000</td>
      <td>7490.625</td>
      <td>7490.625</td>
    </tr>
    <tr>
      <th>4870</th>
      <td>7954</td>
      <td>10002</td>
      <td>MBNC</td>
      <td>1990-04-30</td>
      <td>0.000000</td>
      <td>7490.625</td>
      <td>7490.625</td>
    </tr>
    <tr>
      <th>4871</th>
      <td>7954</td>
      <td>10002</td>
      <td>MBNC</td>
      <td>1990-05-31</td>
      <td>0.000000</td>
      <td>7490.625</td>
      <td>7490.625</td>
    </tr>
    <tr>
      <th>4872</th>
      <td>7954</td>
      <td>10002</td>
      <td>MBNC</td>
      <td>1990-06-30</td>
      <td>0.000000</td>
      <td>7490.625</td>
      <td>7490.625</td>
    </tr>
    <tr>
      <th>4873</th>
      <td>7954</td>
      <td>10002</td>
      <td>MBNC</td>
      <td>1990-07-31</td>
      <td>-0.039216</td>
      <td>7196.875</td>
      <td>7490.625</td>
    </tr>
    <tr>
      <th>4874</th>
      <td>7954</td>
      <td>10002</td>
      <td>MBNC</td>
      <td>1990-08-31</td>
      <td>-0.040816</td>
      <td>6903.125</td>
      <td>7196.875</td>
    </tr>
    <tr>
      <th>4875</th>
      <td>7954</td>
      <td>10002</td>
      <td>MBNC</td>
      <td>1990-09-30</td>
      <td>-0.127660</td>
      <td>6021.875</td>
      <td>6903.125</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Rmkt</span><span class="o">=</span><span class="n">crsp</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:(</span><span class="n">x</span><span class="o">.</span><span class="n">ret</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">me_l1</span><span class="o">/</span><span class="n">x</span><span class="o">.</span><span class="n">me_l1</span><span class="o">.</span><span class="n">sum</span><span class="p">()))</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>C:\Users\alan.moreira\AppData\Local\Temp\ipykernel_11444\2889644777.py:1: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  Rmkt=crsp.groupby([&#39;date&#39;]).apply(lambda x:(x.ret*(x.me_l1/x.me_l1.sum())).sum())
</pre></div>
</div>
</div>
</div>
<blockquote>
<div><ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">groupby(['date'])</span></code> method groups the data by month so we obtain the return of the portfolio in that month</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">(x.me/x.me.sum())</span></code> has the weights in a given date, which for each date will return a vector that adds up to one.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">(x.ret*(x.me/x.me.sum())</span></code> multiplies the return of each asset by the weight</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">(x.ret*(x.me/x.me.sum())).sum()</span></code>  sum all up to get the reutrn of the portfolio</p></li>
</ul>
</div></blockquote>
<p>Lets compare our factor with the one ken french website</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#Lets look at the cumulative return</span>
<span class="n">df</span><span class="o">=</span><span class="n">get_factors</span><span class="p">(</span><span class="s1">&#39;CAPM&#39;</span><span class="p">,</span><span class="n">freq</span><span class="o">=</span><span class="s1">&#39;monthly&#39;</span><span class="p">)</span>

<span class="p">(</span><span class="n">Rmkt</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Mkt-RF&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;RF&#39;</span><span class="p">])[</span><span class="s1">&#39;1990&#39;</span><span class="p">:</span><span class="s1">&#39;2019&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>c:\Users\alan.moreira\Anaconda3\lib\site-packages\pandas_datareader\famafrench.py:114: FutureWarning: The argument &#39;date_parser&#39; is deprecated and will be removed in a future version. Please use &#39;date_format&#39; instead, or read your data in as &#39;object&#39; dtype and then call &#39;to_datetime&#39;.
  df = read_csv(StringIO(&quot;Date&quot; + src[start:]), **params)
c:\Users\alan.moreira\Anaconda3\lib\site-packages\pandas_datareader\famafrench.py:114: FutureWarning: The argument &#39;date_parser&#39; is deprecated and will be removed in a future version. Please use &#39;date_format&#39; instead, or read your data in as &#39;object&#39; dtype and then call &#39;to_datetime&#39;.
  df = read_csv(StringIO(&quot;Date&quot; + src[start:]), **params)
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Axes: xlabel=&#39;Date&#39;&gt;
</pre></div>
</div>
<img alt="../../_images/0ff4771fb81abacef15e033f6556e2c46bada0263d8d47425cda750d728d9294.png" src="../../_images/0ff4771fb81abacef15e033f6556e2c46bada0263d8d47425cda750d728d9294.png" />
</div>
</div>
<p><strong>Things to try</strong></p>
<ul class="simple">
<li><p>Suppose you wanted to construct something “like” the SP500? I.e. do market cap weights but only for the 500 largest firms in a given month. How would you do that?</p></li>
<li><p>Suppose you lag market cap 2 months instead of 1 does it make any difference? Do you expect there is any difference</p></li>
<li><p>Suppose you drop the stocks with “negative” prices, does it make a difference?</p></li>
</ul>
</section>
<section id="factor-construction-implementing-the-recipe">
<h2><span class="section-number">10.2. </span>Factor Construction: Implementing the recipe<a class="headerlink" href="#factor-construction-implementing-the-recipe" title="Link to this heading">#</a></h2>
<ol class="arabic simple">
<li><p>We will start with a constructed characteristic <span class="math notranslate nohighlight">\(c_{i,t}\)</span></p></li>
<li><p>Produce 10 portfolios based on this characteristic</p>
<ul class="simple">
<li><p>Members of portfolio 1 in date t have the bottom 10% value of the characteristics in date t</p></li>
<li><p>Members of portfolio 2 in date t have characteristic between 10% and 20% of the characteristics in date t</p></li>
</ul>
</li>
<li><p>Given these memberships for each date we will the construct return by buying at the closing price of date t and selling at the closing on date t+1</p>
<ul class="simple">
<li><p>We will typically work with monthly data, so this should read as the closing of the last date of months t and t+1</p></li>
</ul>
</li>
</ol>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;../../assets/data/characteristics_raw.csv&quot;</span>
<span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;../../assets/data/characteristics_raw.pkl&quot;</span>
<span class="n">parser</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">date</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">date</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;%m/%y&#39;</span><span class="p">)</span>
<span class="n">df_X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">url</span><span class="p">,</span><span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="c1"># This simply shits the date to be in an end of month basis</span>
<span class="n">df_X</span><span class="o">.</span><span class="n">date</span><span class="o">=</span><span class="n">df_X</span><span class="o">.</span><span class="n">date</span><span class="o">+</span><span class="n">pd</span><span class="o">.</span><span class="n">tseries</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">MonthEnd</span><span class="p">()</span>

<span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;../../assets/data/characteristics_raw.csv&quot;</span>
<span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;../../assets/data/characteristics_raw.pkl&quot;</span>

<span class="n">df_X</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_pickle</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="c1"># This simply shits the date to be in an end of month basis</span>
<span class="n">df_X</span><span class="o">.</span><span class="n">date</span><span class="o">=</span><span class="n">df_X</span><span class="o">.</span><span class="n">date</span><span class="o">+</span><span class="n">pd</span><span class="o">.</span><span class="n">tseries</span><span class="o">.</span><span class="n">offsets</span><span class="o">.</span><span class="n">MonthEnd</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
Int64Index: 120396 entries, 366031 to 486426
Data columns (total 34 columns):
 #   Column     Non-Null Count   Dtype         
---  ------     --------------   -----         
 0   date       120396 non-null  datetime64[ns]
 1   permno     120396 non-null  int64         
 2   re         120396 non-null  float64       
 3   rf         120396 non-null  float64       
 4   rme        120396 non-null  float64       
 5   size       120396 non-null  float64       
 6   value      120396 non-null  float64       
 7   prof       120396 non-null  float64       
 8   fscore     120396 non-null  int64         
 9   debtiss    120396 non-null  int64         
 10  repurch    120396 non-null  int64         
 11  nissa      120396 non-null  float64       
 12  growth     120396 non-null  float64       
 13  aturnover  120396 non-null  float64       
 14  gmargins   120396 non-null  float64       
 15  ep         120396 non-null  float64       
 16  sgrowth    120396 non-null  float64       
 17  lev        120396 non-null  float64       
 18  roaa       120396 non-null  float64       
 19  roea       120396 non-null  float64       
 20  sp         120396 non-null  float64       
 21  mom        120396 non-null  float64       
 22  indmom     120396 non-null  int64         
 23  mom12      120396 non-null  float64       
 24  momrev     120396 non-null  float64       
 25  valuem     120396 non-null  float64       
 26  nissm      120396 non-null  float64       
 27  strev      120396 non-null  float64       
 28  ivol       120396 non-null  float64       
 29  betaarb    120396 non-null  float64       
 30  indrrev    120396 non-null  float64       
 31  price      120396 non-null  float64       
 32  age        120396 non-null  float64       
 33  shvol      120396 non-null  float64       
dtypes: datetime64[ns](1), float64(28), int64(5)
memory usage: 32.1 MB
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">crsp</span><span class="o">=</span><span class="n">crsp</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df_X</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;permno&#39;</span><span class="p">])</span>
<span class="n">crsp</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>permco</th>
      <th>permno</th>
      <th>ticker</th>
      <th>date</th>
      <th>ret</th>
      <th>me</th>
      <th>me_l1</th>
      <th>re</th>
      <th>rf</th>
      <th>rme</th>
      <th>size</th>
      <th>value</th>
      <th>prof</th>
      <th>fscore</th>
      <th>debtiss</th>
      <th>repurch</th>
      <th>nissa</th>
      <th>growth</th>
      <th>aturnover</th>
      <th>gmargins</th>
      <th>ep</th>
      <th>sgrowth</th>
      <th>lev</th>
      <th>roaa</th>
      <th>roea</th>
      <th>sp</th>
      <th>mom</th>
      <th>indmom</th>
      <th>mom12</th>
      <th>momrev</th>
      <th>valuem</th>
      <th>nissm</th>
      <th>strev</th>
      <th>ivol</th>
      <th>betaarb</th>
      <th>indrrev</th>
      <th>price</th>
      <th>age</th>
      <th>shvol</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1728</td>
      <td>10016</td>
      <td>FIGIA</td>
      <td>1990-01-31</td>
      <td>0.061539</td>
      <td>4.643850e+05</td>
      <td>NaN</td>
      <td>0.055838</td>
      <td>0.0057</td>
      <td>-0.0785</td>
      <td>13.305966</td>
      <td>-0.283029</td>
      <td>-1.153453</td>
      <td>3</td>
      <td>0</td>
      <td>1</td>
      <td>0.733570</td>
      <td>0.432045</td>
      <td>0.160656</td>
      <td>0.268714</td>
      <td>0.100771</td>
      <td>0.776354</td>
      <td>0.560345</td>
      <td>0.058779</td>
      <td>0.000141</td>
      <td>0.002054</td>
      <td>-0.005552</td>
      <td>13</td>
      <td>0.009040</td>
      <td>0.034664</td>
      <td>-0.021934</td>
      <td>0.608435</td>
      <td>-0.115646</td>
      <td>0.019495</td>
      <td>0.658447</td>
      <td>-0.145349</td>
      <td>4.567625</td>
      <td>3.912023</td>
      <td>0.174350</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1728</td>
      <td>10016</td>
      <td>FIGIA</td>
      <td>1990-02-28</td>
      <td>0.048913</td>
      <td>4.699980e+05</td>
      <td>4.643850e+05</td>
      <td>0.043213</td>
      <td>0.0057</td>
      <td>0.0111</td>
      <td>13.305966</td>
      <td>-0.283029</td>
      <td>-1.153453</td>
      <td>3</td>
      <td>0</td>
      <td>1</td>
      <td>0.733570</td>
      <td>0.432045</td>
      <td>0.160656</td>
      <td>0.268714</td>
      <td>0.100771</td>
      <td>0.776354</td>
      <td>0.560345</td>
      <td>0.058779</td>
      <td>0.000141</td>
      <td>0.002054</td>
      <td>-0.161456</td>
      <td>18</td>
      <td>-0.166502</td>
      <td>0.094141</td>
      <td>-0.307732</td>
      <td>0.608435</td>
      <td>0.061538</td>
      <td>0.019320</td>
      <td>0.659106</td>
      <td>0.137519</td>
      <td>3.530938</td>
      <td>3.931826</td>
      <td>0.168443</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1728</td>
      <td>10016</td>
      <td>FIGIA</td>
      <td>1990-03-31</td>
      <td>-0.010417</td>
      <td>4.787880e+05</td>
      <td>4.699980e+05</td>
      <td>-0.016817</td>
      <td>0.0064</td>
      <td>0.0183</td>
      <td>13.305966</td>
      <td>-0.283029</td>
      <td>-1.153453</td>
      <td>3</td>
      <td>0</td>
      <td>1</td>
      <td>0.733570</td>
      <td>0.432045</td>
      <td>0.160656</td>
      <td>0.268714</td>
      <td>0.100771</td>
      <td>0.776354</td>
      <td>0.560345</td>
      <td>0.058779</td>
      <td>0.000141</td>
      <td>0.002054</td>
      <td>0.007962</td>
      <td>20</td>
      <td>-0.110622</td>
      <td>0.161600</td>
      <td>-0.319747</td>
      <td>0.608435</td>
      <td>0.048913</td>
      <td>0.021825</td>
      <td>0.660083</td>
      <td>0.022764</td>
      <td>3.542953</td>
      <td>3.951244</td>
      <td>0.338065</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1728</td>
      <td>10016</td>
      <td>FIGIA</td>
      <td>1990-04-30</td>
      <td>-0.042105</td>
      <td>4.784205e+05</td>
      <td>4.787880e+05</td>
      <td>-0.049005</td>
      <td>0.0069</td>
      <td>-0.0336</td>
      <td>13.305966</td>
      <td>-0.283029</td>
      <td>-1.153453</td>
      <td>3</td>
      <td>0</td>
      <td>1</td>
      <td>0.733570</td>
      <td>0.432045</td>
      <td>0.160656</td>
      <td>0.268714</td>
      <td>0.100771</td>
      <td>0.776354</td>
      <td>0.560345</td>
      <td>0.058779</td>
      <td>0.000141</td>
      <td>0.002054</td>
      <td>-0.057871</td>
      <td>15</td>
      <td>-0.062867</td>
      <td>0.173230</td>
      <td>-0.338276</td>
      <td>0.610262</td>
      <td>-0.010417</td>
      <td>0.020919</td>
      <td>0.664280</td>
      <td>-0.038410</td>
      <td>3.561924</td>
      <td>3.970292</td>
      <td>0.480344</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1728</td>
      <td>10016</td>
      <td>FIGIA</td>
      <td>1990-05-31</td>
      <td>0.071429</td>
      <td>4.988055e+05</td>
      <td>4.784205e+05</td>
      <td>0.064629</td>
      <td>0.0068</td>
      <td>0.0842</td>
      <td>13.305966</td>
      <td>-0.283029</td>
      <td>-1.153453</td>
      <td>3</td>
      <td>0</td>
      <td>1</td>
      <td>0.733570</td>
      <td>0.432045</td>
      <td>0.160656</td>
      <td>0.268714</td>
      <td>0.100771</td>
      <td>0.776354</td>
      <td>0.560345</td>
      <td>0.058779</td>
      <td>0.000141</td>
      <td>0.002054</td>
      <td>-0.090815</td>
      <td>13</td>
      <td>-0.027429</td>
      <td>0.158248</td>
      <td>-0.084309</td>
      <td>0.610262</td>
      <td>-0.042105</td>
      <td>0.019659</td>
      <td>0.662426</td>
      <td>-0.012621</td>
      <td>3.561156</td>
      <td>3.988984</td>
      <td>0.519281</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>293175</th>
      <td>53453</td>
      <td>93436</td>
      <td>TSLA</td>
      <td>2016-08-31</td>
      <td>-0.097023</td>
      <td>3.164016e+07</td>
      <td>3.491163e+07</td>
      <td>-0.097223</td>
      <td>0.0002</td>
      <td>0.0050</td>
      <td>17.262975</td>
      <td>-3.328269</td>
      <td>-1.793726</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>0.772211</td>
      <td>0.324619</td>
      <td>-0.693198</td>
      <td>0.332695</td>
      <td>-0.028577</td>
      <td>0.817589</td>
      <td>-1.360429</td>
      <td>-0.116325</td>
      <td>-0.000786</td>
      <td>0.000128</td>
      <td>-0.122774</td>
      <td>22</td>
      <td>-0.226154</td>
      <td>0.187434</td>
      <td>-3.467612</td>
      <td>0.774498</td>
      <td>0.106039</td>
      <td>0.023503</td>
      <td>1.202041</td>
      <td>0.016793</td>
      <td>5.458691</td>
      <td>4.330733</td>
      <td>2.039172</td>
    </tr>
    <tr>
      <th>293176</th>
      <td>53453</td>
      <td>93436</td>
      <td>TSLA</td>
      <td>2016-09-30</td>
      <td>-0.037640</td>
      <td>3.056879e+07</td>
      <td>3.164016e+07</td>
      <td>-0.037840</td>
      <td>0.0002</td>
      <td>0.0025</td>
      <td>17.262975</td>
      <td>-3.328269</td>
      <td>-1.793726</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>0.772211</td>
      <td>0.324619</td>
      <td>-0.693198</td>
      <td>0.332695</td>
      <td>-0.028577</td>
      <td>0.817589</td>
      <td>-1.360429</td>
      <td>-0.116325</td>
      <td>-0.000786</td>
      <td>0.000128</td>
      <td>0.205371</td>
      <td>14</td>
      <td>-0.059002</td>
      <td>0.267903</td>
      <td>-3.484510</td>
      <td>0.765204</td>
      <td>-0.097023</td>
      <td>0.020798</td>
      <td>1.216683</td>
      <td>-0.092388</td>
      <td>5.356633</td>
      <td>4.343805</td>
      <td>1.908743</td>
    </tr>
    <tr>
      <th>293177</th>
      <td>53453</td>
      <td>93436</td>
      <td>TSLA</td>
      <td>2016-10-31</td>
      <td>-0.030878</td>
      <td>2.963795e+07</td>
      <td>3.056879e+07</td>
      <td>-0.031078</td>
      <td>0.0002</td>
      <td>-0.0202</td>
      <td>17.262975</td>
      <td>-3.328269</td>
      <td>-1.793726</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>0.772211</td>
      <td>0.324619</td>
      <td>-0.693198</td>
      <td>0.332695</td>
      <td>-0.028577</td>
      <td>0.817589</td>
      <td>-1.360429</td>
      <td>-0.116325</td>
      <td>-0.000786</td>
      <td>0.000128</td>
      <td>0.099503</td>
      <td>7</td>
      <td>-0.158407</td>
      <td>0.202814</td>
      <td>-3.450063</td>
      <td>0.762938</td>
      <td>-0.037640</td>
      <td>0.015124</td>
      <td>1.225626</td>
      <td>-0.034816</td>
      <td>5.318267</td>
      <td>4.356709</td>
      <td>1.724083</td>
    </tr>
    <tr>
      <th>293178</th>
      <td>53453</td>
      <td>93436</td>
      <td>TSLA</td>
      <td>2016-11-30</td>
      <td>-0.042128</td>
      <td>2.840318e+07</td>
      <td>2.963795e+07</td>
      <td>-0.042228</td>
      <td>0.0001</td>
      <td>0.0486</td>
      <td>17.262975</td>
      <td>-3.328269</td>
      <td>-1.793726</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>0.772211</td>
      <td>0.324619</td>
      <td>-0.693198</td>
      <td>0.332695</td>
      <td>-0.028577</td>
      <td>0.817589</td>
      <td>-1.360429</td>
      <td>-0.116325</td>
      <td>-0.000786</td>
      <td>0.000128</td>
      <td>-0.118812</td>
      <td>6</td>
      <td>-0.014113</td>
      <td>0.274511</td>
      <td>-3.419139</td>
      <td>0.762969</td>
      <td>-0.030878</td>
      <td>0.016082</td>
      <td>1.251558</td>
      <td>0.001584</td>
      <td>5.286902</td>
      <td>4.369448</td>
      <td>1.792732</td>
    </tr>
    <tr>
      <th>293179</th>
      <td>53453</td>
      <td>93436</td>
      <td>TSLA</td>
      <td>2016-12-31</td>
      <td>0.128247</td>
      <td>3.452397e+07</td>
      <td>2.840318e+07</td>
      <td>0.127947</td>
      <td>0.0003</td>
      <td>0.0182</td>
      <td>17.262975</td>
      <td>-3.328269</td>
      <td>-1.793726</td>
      <td>2</td>
      <td>0</td>
      <td>0</td>
      <td>0.772211</td>
      <td>0.324619</td>
      <td>-0.693198</td>
      <td>0.332695</td>
      <td>-0.028577</td>
      <td>0.817589</td>
      <td>-1.360429</td>
      <td>-0.116325</td>
      <td>-0.000786</td>
      <td>0.000128</td>
      <td>-0.196898</td>
      <td>18</td>
      <td>-0.152307</td>
      <td>-0.088376</td>
      <td>-2.422126</td>
      <td>0.763229</td>
      <td>-0.042128</td>
      <td>0.018539</td>
      <td>1.255059</td>
      <td>-0.109353</td>
      <td>5.243861</td>
      <td>4.382027</td>
      <td>1.919764</td>
    </tr>
  </tbody>
</table>
<p>293180 rows × 39 columns</p>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_rows&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_columns&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.width&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_colwidth&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

<span class="n">display</span><span class="p">(</span><span class="n">crsp</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>count</th>
      <th>mean</th>
      <th>min</th>
      <th>25%</th>
      <th>50%</th>
      <th>75%</th>
      <th>max</th>
      <th>std</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>permco</th>
      <td>293180.0</td>
      <td>18069.997551</td>
      <td>4.0</td>
      <td>8625.0</td>
      <td>20478.0</td>
      <td>21640.0</td>
      <td>54638.0</td>
      <td>11619.56875</td>
    </tr>
    <tr>
      <th>permno</th>
      <td>293180.0</td>
      <td>53709.507579</td>
      <td>10016.0</td>
      <td>25443.0</td>
      <td>57250.0</td>
      <td>78829.0</td>
      <td>93436.0</td>
      <td>26831.904059</td>
    </tr>
    <tr>
      <th>date</th>
      <td>293180</td>
      <td>2003-06-20 08:44:33.317415936</td>
      <td>1990-01-31 00:00:00</td>
      <td>1996-05-31 00:00:00</td>
      <td>2003-08-31 00:00:00</td>
      <td>2010-04-30 00:00:00</td>
      <td>2016-12-31 00:00:00</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>ret</th>
      <td>293180.0</td>
      <td>0.01024</td>
      <td>-0.868645</td>
      <td>-0.041258</td>
      <td>0.010113</td>
      <td>0.060915</td>
      <td>1.598007</td>
      <td>0.100783</td>
    </tr>
    <tr>
      <th>me</th>
      <td>293180.0</td>
      <td>11091532.712568</td>
      <td>134862.0</td>
      <td>1776623.1825</td>
      <td>3377469.825</td>
      <td>8527774.4975</td>
      <td>750709577.84</td>
      <td>28288271.838849</td>
    </tr>
    <tr>
      <th>me_l1</th>
      <td>292272.0</td>
      <td>11051461.232868</td>
      <td>189894.375</td>
      <td>1774892.96875</td>
      <td>3361221.745</td>
      <td>8490989.695</td>
      <td>750709577.84</td>
      <td>28184753.00716</td>
    </tr>
    <tr>
      <th>re</th>
      <td>293180.0</td>
      <td>0.007906</td>
      <td>-0.870345</td>
      <td>-0.043613</td>
      <td>0.007857</td>
      <td>0.058641</td>
      <td>1.597907</td>
      <td>0.100818</td>
    </tr>
    <tr>
      <th>rf</th>
      <td>293180.0</td>
      <td>0.002343</td>
      <td>0.0</td>
      <td>0.0001</td>
      <td>0.0024</td>
      <td>0.0041</td>
      <td>0.0069</td>
      <td>0.001936</td>
    </tr>
    <tr>
      <th>rme</th>
      <td>293180.0</td>
      <td>0.0065</td>
      <td>-0.1723</td>
      <td>-0.0192</td>
      <td>0.0117</td>
      <td>0.0337</td>
      <td>0.1135</td>
      <td>0.042076</td>
    </tr>
    <tr>
      <th>size</th>
      <td>293180.0</td>
      <td>15.175505</td>
      <td>9.987944</td>
      <td>14.31994</td>
      <td>14.995711</td>
      <td>15.92163</td>
      <td>20.388632</td>
      <td>1.270192</td>
    </tr>
    <tr>
      <th>value</th>
      <td>293180.0</td>
      <td>-0.882038</td>
      <td>-8.756389</td>
      <td>-1.328362</td>
      <td>-0.8091</td>
      <td>-0.330202</td>
      <td>2.546915</td>
      <td>0.782379</td>
    </tr>
    <tr>
      <th>prof</th>
      <td>293180.0</td>
      <td>-1.551566</td>
      <td>-10.213809</td>
      <td>-2.151287</td>
      <td>-1.350972</td>
      <td>-0.820757</td>
      <td>0.837982</td>
      <td>0.985428</td>
    </tr>
    <tr>
      <th>fscore</th>
      <td>293180.0</td>
      <td>4.844304</td>
      <td>0.0</td>
      <td>4.0</td>
      <td>5.0</td>
      <td>6.0</td>
      <td>8.0</td>
      <td>1.340862</td>
    </tr>
    <tr>
      <th>debtiss</th>
      <td>293180.0</td>
      <td>0.363364</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.480969</td>
    </tr>
    <tr>
      <th>repurch</th>
      <td>293180.0</td>
      <td>0.579177</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>1.0</td>
      <td>0.493692</td>
    </tr>
    <tr>
      <th>nissa</th>
      <td>293180.0</td>
      <td>0.707668</td>
      <td>0.210461</td>
      <td>0.686906</td>
      <td>0.695167</td>
      <td>0.70468</td>
      <td>4.265005</td>
      <td>0.071252</td>
    </tr>
    <tr>
      <th>growth</th>
      <td>293180.0</td>
      <td>0.123943</td>
      <td>-2.704821</td>
      <td>0.01521</td>
      <td>0.077629</td>
      <td>0.172152</td>
      <td>4.030048</td>
      <td>0.232183</td>
    </tr>
    <tr>
      <th>aturnover</th>
      <td>293180.0</td>
      <td>-0.489112</td>
      <td>-9.784996</td>
      <td>-0.990074</td>
      <td>-0.285957</td>
      <td>0.173702</td>
      <td>2.578508</td>
      <td>0.989544</td>
    </tr>
    <tr>
      <th>gmargins</th>
      <td>293180.0</td>
      <td>0.4072</td>
      <td>0.001052</td>
      <td>0.244984</td>
      <td>0.371098</td>
      <td>0.55348</td>
      <td>1.0</td>
      <td>0.211862</td>
    </tr>
    <tr>
      <th>ep</th>
      <td>293180.0</td>
      <td>0.044476</td>
      <td>-3.820301</td>
      <td>0.031911</td>
      <td>0.051463</td>
      <td>0.071341</td>
      <td>0.677732</td>
      <td>0.101402</td>
    </tr>
    <tr>
      <th>sgrowth</th>
      <td>293180.0</td>
      <td>0.755035</td>
      <td>0.095088</td>
      <td>0.701008</td>
      <td>0.73566</td>
      <td>0.784663</td>
      <td>8.217025</td>
      <td>0.137407</td>
    </tr>
    <tr>
      <th>lev</th>
      <td>293180.0</td>
      <td>0.138455</td>
      <td>-4.350186</td>
      <td>-0.593939</td>
      <td>0.058093</td>
      <td>0.777652</td>
      <td>5.453758</td>
      <td>1.097426</td>
    </tr>
    <tr>
      <th>roaa</th>
      <td>293180.0</td>
      <td>0.051655</td>
      <td>-4.83761</td>
      <td>0.017779</td>
      <td>0.047024</td>
      <td>0.0838</td>
      <td>0.578345</td>
      <td>0.075349</td>
    </tr>
    <tr>
      <th>roea</th>
      <td>293180.0</td>
      <td>0.000155</td>
      <td>-0.033125</td>
      <td>0.000074</td>
      <td>0.000124</td>
      <td>0.000182</td>
      <td>0.336472</td>
      <td>0.002284</td>
    </tr>
    <tr>
      <th>sp</th>
      <td>293180.0</td>
      <td>0.001091</td>
      <td>0.0</td>
      <td>0.00039</td>
      <td>0.00072</td>
      <td>0.001261</td>
      <td>0.036622</td>
      <td>0.001345</td>
    </tr>
    <tr>
      <th>mom</th>
      <td>293180.0</td>
      <td>0.065233</td>
      <td>-3.034658</td>
      <td>-0.053009</td>
      <td>0.072998</td>
      <td>0.192949</td>
      <td>2.658795</td>
      <td>0.24643</td>
    </tr>
    <tr>
      <th>indmom</th>
      <td>293180.0</td>
      <td>25.402606</td>
      <td>1.0</td>
      <td>14.0</td>
      <td>25.0</td>
      <td>37.0</td>
      <td>49.0</td>
      <td>13.385737</td>
    </tr>
    <tr>
      <th>mom12</th>
      <td>293180.0</td>
      <td>0.121709</td>
      <td>-3.475013</td>
      <td>-0.040944</td>
      <td>0.127765</td>
      <td>0.29066</td>
      <td>3.519333</td>
      <td>0.33215</td>
    </tr>
    <tr>
      <th>momrev</th>
      <td>293180.0</td>
      <td>0.070902</td>
      <td>-3.055986</td>
      <td>-0.047574</td>
      <td>0.078028</td>
      <td>0.198778</td>
      <td>3.302411</td>
      <td>0.252989</td>
    </tr>
    <tr>
      <th>valuem</th>
      <td>293180.0</td>
      <td>-0.930936</td>
      <td>-8.818536</td>
      <td>-1.376003</td>
      <td>-0.8698</td>
      <td>-0.389042</td>
      <td>2.329125</td>
      <td>0.784738</td>
    </tr>
    <tr>
      <th>nissm</th>
      <td>293180.0</td>
      <td>0.707038</td>
      <td>0.210461</td>
      <td>0.686502</td>
      <td>0.695088</td>
      <td>0.704374</td>
      <td>2.711109</td>
      <td>0.069334</td>
    </tr>
    <tr>
      <th>strev</th>
      <td>293180.0</td>
      <td>0.016614</td>
      <td>-0.868645</td>
      <td>-0.037116</td>
      <td>0.013462</td>
      <td>0.0653</td>
      <td>6.407407</td>
      <td>0.103283</td>
    </tr>
    <tr>
      <th>ivol</th>
      <td>293180.0</td>
      <td>0.017323</td>
      <td>0.000014</td>
      <td>0.010952</td>
      <td>0.015031</td>
      <td>0.021029</td>
      <td>0.218682</td>
      <td>0.009499</td>
    </tr>
    <tr>
      <th>betaarb</th>
      <td>293180.0</td>
      <td>1.005516</td>
      <td>-0.060274</td>
      <td>0.820955</td>
      <td>0.975405</td>
      <td>1.153643</td>
      <td>2.350102</td>
      <td>0.25847</td>
    </tr>
    <tr>
      <th>indrrev</th>
      <td>293180.0</td>
      <td>0.006534</td>
      <td>-0.820129</td>
      <td>-0.036277</td>
      <td>0.002318</td>
      <td>0.043597</td>
      <td>6.286577</td>
      <td>0.085976</td>
    </tr>
    <tr>
      <th>price</th>
      <td>293180.0</td>
      <td>3.615703</td>
      <td>0.57098</td>
      <td>3.233764</td>
      <td>3.614291</td>
      <td>3.987586</td>
      <td>11.631769</td>
      <td>0.642522</td>
    </tr>
    <tr>
      <th>age</th>
      <td>293180.0</td>
      <td>5.469735</td>
      <td>3.637586</td>
      <td>4.990433</td>
      <td>5.605802</td>
      <td>6.049733</td>
      <td>6.555357</td>
      <td>0.715066</td>
    </tr>
    <tr>
      <th>shvol</th>
      <td>293180.0</td>
      <td>0.849904</td>
      <td>0.002322</td>
      <td>0.474115</td>
      <td>0.778421</td>
      <td>1.143757</td>
      <td>4.319359</td>
      <td>0.481603</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<section id="what-are-these-characteristics">
<h3><span class="section-number">10.2.1. </span>What are these characteristics?<a class="headerlink" href="#what-are-these-characteristics" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>They are based on various accounting and market based information</p></li>
<li><p>For detailed description see pages of</p></li>
<li><p>Each characteristic is constructed differently–we will discuss in detail a handful of them</p></li>
<li><p>But the characteristics signals we have here are equal to cross-sectional ranks of a given stock’s characteristic, centered, and normalized by the sum of absolute values of all ranks in the cross section.
$<span class="math notranslate nohighlight">\(\frac{c_{i,t}-\overline{c}_t}{\sum_i|c_{i,t}-\overline{c}_t|}\)</span>$</p></li>
</ul>
<blockquote>
<div><ul class="simple">
<li><p>For what we are doing here this does not matter at all. Our sorting procedure is already defacto doing that</p></li>
<li><p>This will matter if we use these characteristics to run regressions directly–more on this soon</p></li>
</ul>
</div></blockquote>
<p><strong>Group assets by signal</strong></p>
<ul class="simple">
<li><p>We select our characteristic</p></li>
<li><p>We now need to assign groups to each stocks. These groups will identify which portfolio each stock belongs in a particular date according to the position of the characteristic in that date</p></li>
<li><p>We will do this by applying the function <a class="reference external" href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.qcut.html">pd.qcut</a>  to the chosen characteristic. This will “cut” the signal distribution in the chosen number of groups.</p></li>
<li><p>The important aspects is that we will applying this date by date. This make the strategy cross-sectional because you are using the distribution of the signal as given date to the grouping– Very much like curved grades by cohort</p></li>
<li><p>Details</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">duplicates='drop'</span></code>: In case there are two stocks with exactly the same signal that are exactly in the cutoff of the groups, we drop one of the observations</p></li>
<li><p><code class="docutils literal notranslate"> <span class="pre">labels=False</span></code>: The method simply label the groups with numbers. For example if <code class="docutils literal notranslate"><span class="pre">ngroups=10</span></code> then it will assign <code class="docutils literal notranslate"><span class="pre">0</span></code> to the stocks with the  bottom 10% returns in a given date, <code class="docutils literal notranslate"><span class="pre">1</span></code> to stocks with returns in between 10% and 20% of the signal distribution on a given date, …, and 9 for stocks in the top 10% (signal in between 90% and 100% of the return distribution on a given date) .</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X</span><span class="o">=</span><span class="s1">&#39;value&#39;</span>

<span class="n">ngroups</span><span class="o">=</span><span class="mi">10</span>
<span class="n">crsp</span><span class="p">[</span><span class="s1">&#39;X_group&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">crsp</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">])[</span><span class="n">X</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ngroups</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">duplicates</span><span class="o">=</span><span class="s1">&#39;drop&#39;</span><span class="p">))</span>
<span class="n">crsp</span><span class="p">[[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;permco&#39;</span><span class="p">,</span><span class="s1">&#39;ticker&#39;</span><span class="p">,</span><span class="n">X</span><span class="p">,</span><span class="s1">&#39;X_group&#39;</span><span class="p">]]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>permco</th>
      <th>ticker</th>
      <th>value</th>
      <th>X_group</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1990-01-31</td>
      <td>1728</td>
      <td>FIGIA</td>
      <td>-0.283029</td>
      <td>5</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1990-02-28</td>
      <td>1728</td>
      <td>FIGIA</td>
      <td>-0.283029</td>
      <td>5</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1990-03-31</td>
      <td>1728</td>
      <td>FIGIA</td>
      <td>-0.283029</td>
      <td>5</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1990-04-30</td>
      <td>1728</td>
      <td>FIGIA</td>
      <td>-0.283029</td>
      <td>5</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1990-05-31</td>
      <td>1728</td>
      <td>FIGIA</td>
      <td>-0.283029</td>
      <td>5</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>293175</th>
      <td>2016-08-31</td>
      <td>53453</td>
      <td>TSLA</td>
      <td>-3.328269</td>
      <td>0</td>
    </tr>
    <tr>
      <th>293176</th>
      <td>2016-09-30</td>
      <td>53453</td>
      <td>TSLA</td>
      <td>-3.328269</td>
      <td>0</td>
    </tr>
    <tr>
      <th>293177</th>
      <td>2016-10-31</td>
      <td>53453</td>
      <td>TSLA</td>
      <td>-3.328269</td>
      <td>0</td>
    </tr>
    <tr>
      <th>293178</th>
      <td>2016-11-30</td>
      <td>53453</td>
      <td>TSLA</td>
      <td>-3.328269</td>
      <td>0</td>
    </tr>
    <tr>
      <th>293179</th>
      <td>2016-12-31</td>
      <td>53453</td>
      <td>TSLA</td>
      <td>-3.328269</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
<p>293180 rows × 5 columns</p>
</div></div></div>
</div>
<blockquote>
<div><p><strong>Portfolio formation tradeoffs: Diversification vs Signal Strengh</strong></p>
<ul class="simple">
<li><p>We will start by constructing Equal weighted portfolios within each signal bucket</p></li>
<li><p>Why not sort in 100 groups instead on only 10? This way your top portfolio would have much higher average characteristics</p></li>
<li><p>Why no simply focus on the stock with the highest characteristic?</p></li>
</ul>
</div></blockquote>
<blockquote>
<div><ol class="arabic simple">
<li><p>Individual stocks have <span class="math notranslate nohighlight">\(\sigma\)</span> = 40 − 80%, so <span class="math notranslate nohighlight">\(\sigma/\sqrt{T}\)</span> makes it nearly impossible to accurately measure E(R). Portfolios have lower <span class="math notranslate nohighlight">\(\sigma\)</span> by diversification.</p></li>
<li><p>So  you have to trade-off strengh of the signal against benefits of diversification</p></li>
</ol>
</div></blockquote>
<p><strong>Calculate the portfolio return</strong></p>
<p>We will do market cap weights, but you could do Equal weight or even sginal weights</p>
<div class="math notranslate nohighlight">
\[\sum_i^I w_{it} r_{it}\]</div>
<p>Where the weights must add up to 1.</p>
<p>Before forming portfolios we will use the risk-free rate so we form fully invested portfolios. So the ouput will be returns and not excess returns</p>
<p><strong>Equal weighted returns</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ret_byX_ew</span> <span class="o">=</span><span class="n">crsp</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;X_group&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">ret</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">ret_byX_ew</span><span class="o">=</span><span class="n">ret_byX_ew</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">level</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="p">(</span><span class="n">ret_byX_ew</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Axes: xlabel=&#39;date&#39;&gt;
</pre></div>
</div>
<img alt="../../_images/c0bd9401ee9b840488f372685376c0eef9495b39f2edf1b17ff8bfca4e1d2f16.png" src="../../_images/c0bd9401ee9b840488f372685376c0eef9495b39f2edf1b17ff8bfca4e1d2f16.png" />
</div>
</div>
<p><strong>Market cap weighted returns</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ret_byX_vw</span> <span class="o">=</span><span class="n">crsp</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;X_group&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:(</span><span class="n">x</span><span class="o">.</span><span class="n">ret</span><span class="o">*</span><span class="n">x</span><span class="o">.</span><span class="n">me_l1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="n">x</span><span class="o">.</span><span class="n">me_l1</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
<span class="n">ret_byX_vw</span><span class="o">=</span><span class="n">ret_byX_vw</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">level</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="p">(</span><span class="n">ret_byX_vw</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>C:\Users\alan.moreira\AppData\Local\Temp\ipykernel_11444\2314388641.py:1: RuntimeWarning: invalid value encountered in scalar divide
  ret_byX_vw =crsp.groupby([&#39;date&#39;,&#39;X_group&#39;]).apply(lambda x:(x.ret*x.me_l1).sum()/x.me_l1.sum())
C:\Users\alan.moreira\AppData\Local\Temp\ipykernel_11444\2314388641.py:1: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  ret_byX_vw =crsp.groupby([&#39;date&#39;,&#39;X_group&#39;]).apply(lambda x:(x.ret*x.me_l1).sum()/x.me_l1.sum())
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Axes: xlabel=&#39;date&#39;&gt;
</pre></div>
</div>
<img alt="../../_images/5adca95019b52e9cdce75960ec5a9048b7077190e22680aa2675f64322b58844.png" src="../../_images/5adca95019b52e9cdce75960ec5a9048b7077190e22680aa2675f64322b58844.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_byX_vw</span> <span class="o">=</span><span class="n">crsp</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;X_group&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:(</span><span class="n">x</span><span class="p">[</span><span class="n">X</span><span class="p">]</span><span class="o">*</span><span class="n">x</span><span class="o">.</span><span class="n">me_l1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="n">x</span><span class="o">.</span><span class="n">me_l1</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
<span class="n">X_byX_vw</span><span class="o">=</span><span class="n">X_byX_vw</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">level</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<span class="p">(</span><span class="n">X_byX_vw</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>C:\Users\alan.moreira\AppData\Local\Temp\ipykernel_11444\505524678.py:1: RuntimeWarning: invalid value encountered in scalar divide
  X_byX_vw =crsp.groupby([&#39;date&#39;,&#39;X_group&#39;]).apply(lambda x:(x[X]*x.me_l1).sum()/x.me_l1.sum())
C:\Users\alan.moreira\AppData\Local\Temp\ipykernel_11444\505524678.py:1: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  X_byX_vw =crsp.groupby([&#39;date&#39;,&#39;X_group&#39;]).apply(lambda x:(x[X]*x.me_l1).sum()/x.me_l1.sum())
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Axes: xlabel=&#39;date&#39;&gt;
</pre></div>
</div>
<img alt="../../_images/a0b294d9172e81fdd2279d5993d3a4a70602b6c002fee3940d78ff7f18d7eec3.png" src="../../_images/a0b294d9172e81fdd2279d5993d3a4a70602b6c002fee3940d78ff7f18d7eec3.png" />
</div>
</div>
<p>If we focus on a particular stock, we can see how it’s portfolio membership changed over time.</p>
<p>You can check you that some characteristics are fairly persistent and change only slowly over time</p>
<p>While others, like momentum change very frequently.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">crsp</span><span class="p">[</span><span class="n">crsp</span><span class="o">.</span><span class="n">ticker</span><span class="o">==</span><span class="s1">&#39;MSFT&#39;</span><span class="p">][[</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;X_group&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="s1">&#39;X_group&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Axes: xlabel=&#39;date&#39;&gt;
</pre></div>
</div>
<img alt="../../_images/f0f5171e9230c8821f6ac31d4349e0f790807021010818219217fb0ae3f7f33d.png" src="../../_images/f0f5171e9230c8821f6ac31d4349e0f790807021010818219217fb0ae3f7f33d.png" />
</div>
</div>
<blockquote>
<div><h3 class="rubric" id="wrapping-all-in-a-function-that-goes-from-the-signal-to-the-portfolio">Wrapping all in a function that goes from the signal to the portfolio</h3>
<p>Things to try</p>
<ul class="simple">
<li><p>Play with different number of groups, how the spread in X across portfolios change? How the volatility of the individual portfolios change?</p></li>
<li><p>Look at different characteristics. Which ones create higher spread in average returns</p></li>
<li><p>Construct the long-short portfolio that goes long the high portfolio and short the low portfolio. What are the properties of this portfolio?</p></li>
<li><p>Which ones have alpha relative to the market in the sample? What do their betas look like</p></li>
<li><p>When they perform poorly?</p></li>
<li><p>How correlated are the returns of the long-shorts of different characteristics?</p></li>
</ul>
</div></blockquote>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">returnbyX</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="s1">&#39;ret&#39;</span><span class="p">,</span><span class="n">X</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">,</span><span class="n">ngroups</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;X_group&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">])[</span><span class="n">X</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">qcut</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ngroups</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">duplicates</span><span class="o">=</span><span class="s1">&#39;drop&#39;</span><span class="p">))</span>
    <span class="n">ret</span> <span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;date&#39;</span><span class="p">,</span><span class="s1">&#39;X_group&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:(</span><span class="n">x</span><span class="p">[</span><span class="n">y</span><span class="p">]</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;me_l1&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;me_l1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="n">ret</span><span class="o">=</span><span class="n">ret</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">level</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">y</span><span class="o">==</span><span class="s1">&#39;ret&#39;</span><span class="p">:</span>
            <span class="p">(</span><span class="n">ret</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ret</span>


<span class="n">returnbyX</span><span class="p">(</span><span class="n">crsp</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="s1">&#39;ret&#39;</span><span class="p">,</span><span class="n">X</span><span class="o">=</span><span class="s1">&#39;lev&#39;</span><span class="p">,</span><span class="n">ngroups</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>C:\Users\alan.moreira\AppData\Local\Temp\ipykernel_11444\3238776950.py:3: RuntimeWarning: invalid value encountered in scalar divide
  ret =df.groupby([&#39;date&#39;,&#39;X_group&#39;]).apply(lambda x:(x[y]*x[&#39;me_l1&#39;]).sum()/x[&#39;me_l1&#39;].sum())
C:\Users\alan.moreira\AppData\Local\Temp\ipykernel_11444\3238776950.py:3: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  ret =df.groupby([&#39;date&#39;,&#39;X_group&#39;]).apply(lambda x:(x[y]*x[&#39;me_l1&#39;]).sum()/x[&#39;me_l1&#39;].sum())
C:\Users\alan.moreira\AppData\Local\Temp\ipykernel_11444\3238776950.py:3: RuntimeWarning: invalid value encountered in scalar divide
  ret =df.groupby([&#39;date&#39;,&#39;X_group&#39;]).apply(lambda x:(x[y]*x[&#39;me_l1&#39;]).sum()/x[&#39;me_l1&#39;].sum())
C:\Users\alan.moreira\AppData\Local\Temp\ipykernel_11444\3238776950.py:3: DeprecationWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  ret =df.groupby([&#39;date&#39;,&#39;X_group&#39;]).apply(lambda x:(x[y]*x[&#39;me_l1&#39;]).sum()/x[&#39;me_l1&#39;].sum())
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>X_group</th>
      <th>0</th>
      <th>1</th>
      <th>2</th>
      <th>3</th>
      <th>4</th>
      <th>5</th>
      <th>6</th>
      <th>7</th>
      <th>8</th>
      <th>9</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1990-01-31</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1990-02-28</th>
      <td>-1.083698</td>
      <td>-0.551634</td>
      <td>-0.206633</td>
      <td>0.060585</td>
      <td>0.361918</td>
      <td>0.578973</td>
      <td>0.781533</td>
      <td>1.062372</td>
      <td>1.801000</td>
      <td>2.889168</td>
    </tr>
    <tr>
      <th>1990-03-31</th>
      <td>-1.084339</td>
      <td>-0.554087</td>
      <td>-0.215651</td>
      <td>0.052349</td>
      <td>0.353376</td>
      <td>0.562444</td>
      <td>0.769665</td>
      <td>1.052741</td>
      <td>1.776174</td>
      <td>2.887585</td>
    </tr>
    <tr>
      <th>1990-04-30</th>
      <td>-1.078115</td>
      <td>-0.555431</td>
      <td>-0.213144</td>
      <td>0.053774</td>
      <td>0.336041</td>
      <td>0.532910</td>
      <td>0.762101</td>
      <td>1.044807</td>
      <td>1.753875</td>
      <td>2.881798</td>
    </tr>
    <tr>
      <th>1990-05-31</th>
      <td>-1.075433</td>
      <td>-0.557567</td>
      <td>-0.219284</td>
      <td>0.050308</td>
      <td>0.334485</td>
      <td>0.530823</td>
      <td>0.761987</td>
      <td>1.049479</td>
      <td>1.771789</td>
      <td>2.889317</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2016-08-31</th>
      <td>-1.596653</td>
      <td>-1.058609</td>
      <td>-0.701885</td>
      <td>-0.421573</td>
      <td>-0.177375</td>
      <td>0.064205</td>
      <td>0.323475</td>
      <td>0.622899</td>
      <td>1.077327</td>
      <td>2.164778</td>
    </tr>
    <tr>
      <th>2016-09-30</th>
      <td>-1.581177</td>
      <td>-1.042893</td>
      <td>-0.700905</td>
      <td>-0.416991</td>
      <td>-0.170988</td>
      <td>0.073089</td>
      <td>0.335924</td>
      <td>0.632093</td>
      <td>1.098129</td>
      <td>2.177939</td>
    </tr>
    <tr>
      <th>2016-10-31</th>
      <td>-1.582634</td>
      <td>-1.041939</td>
      <td>-0.692725</td>
      <td>-0.412244</td>
      <td>-0.175641</td>
      <td>0.066141</td>
      <td>0.331990</td>
      <td>0.632146</td>
      <td>1.095394</td>
      <td>2.183576</td>
    </tr>
    <tr>
      <th>2016-11-30</th>
      <td>-1.579295</td>
      <td>-1.041436</td>
      <td>-0.702237</td>
      <td>-0.418805</td>
      <td>-0.177470</td>
      <td>0.063593</td>
      <td>0.333684</td>
      <td>0.636818</td>
      <td>1.115579</td>
      <td>2.196840</td>
    </tr>
    <tr>
      <th>2016-12-31</th>
      <td>-1.567408</td>
      <td>-1.019260</td>
      <td>-0.688559</td>
      <td>-0.398026</td>
      <td>-0.153990</td>
      <td>0.084410</td>
      <td>0.346425</td>
      <td>0.639101</td>
      <td>1.129714</td>
      <td>2.204955</td>
    </tr>
  </tbody>
</table>
<p>324 rows × 10 columns</p>
</div></div><img alt="../../_images/1f5710fe673c40d2814fdff760894aae830f46b3d279b0b05a0af1753ed9d0b6.png" src="../../_images/1f5710fe673c40d2814fdff760894aae830f46b3d279b0b05a0af1753ed9d0b6.png" />
<img alt="../../_images/fde088029aeeec9f0d8870fef88a1f5cbdfa6e4ddcdb3f063eeeb634488a7e88.png" src="../../_images/fde088029aeeec9f0d8870fef88a1f5cbdfa6e4ddcdb3f063eeeb634488a7e88.png" />
</div>
</div>
<blockquote>
<div><h2 class="rubric" id="takeaways">Takeaways</h2>
<ul class="simple">
<li><p>Working with large portfolios of stocks requires stacked dataframes</p></li>
<li><p>Market-cap weighted portfolios should be the default option for portfolio construction–Important to used lagged market cap to avoid look-ahead bias</p></li>
<li><p>Characteristic-based portfolio require data by date-firm on the specific characteristic</p></li>
<li><p>These portfolios focus on spread in the signal across assets in a given date</p></li>
<li><p>Tradeoff between signal strength and diversification</p></li>
</ul>
</div></blockquote>
</section>
</section>
<div class="toctree-wrapper compound">
</div>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./chapters/Finance"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="Performance_evaluation.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><span class="section-number">9. </span>Performance Evaluation</p>
      </div>
    </a>
    <a class="right-next"
       href="Momentum.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">10.3. </span>Signal Construction</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-market-cap-weighted-strategy">10.1. The Market-Cap Weighted strategy</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#factor-construction-implementing-the-recipe">10.2. Factor Construction: Implementing the recipe</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#what-are-these-characteristics">10.2.1. What are these characteristics?</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Alan Moreira
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2021 Creative Commons Attribution-ShareAlike 4.0 International (CC BY-SA 4.0).
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>